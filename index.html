<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.S. Studio - Barbería Profesional</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    </head>
    <style>
    
        /* Variables de tema oscuro */
        :root {
            --primary: #d4af37;
            --primary-dark: #b8941f;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --gray-light: #3a3a3a;
            --success: #4caf50;
            --error: #f44336;
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header y navegación */
        header {
            background-color: var(--darker);
            padding: 20px 0;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 2.5rem;
        }

        .logo h1 {
            font-size: 2.5rem;
            color: var(--primary);
            letter-spacing: 2px;
        }

        .tagline {
            text-align: center;
            color: #aaa;
            font-style: italic;
            margin-top: 5px;
        }

        /* Navegación entre páginas */
        .page-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .page-btn {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 10px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .page-btn:hover,
        .page-btn.active {
            background-color: var(--primary);
            color: var(--dark);
        }

        /* Secciones generales */
        section {
            padding: 40px 0;
            border-bottom: 1px solid var(--gray);
        }

        .section-title {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }

        .section-title:after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background-color: var(--primary);
            margin: 10px auto;
        }

        /* Bienvenida */
        .welcome {
            text-align: center;
            padding: 60px 0;
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1174&q=80') center/cover no-repeat;
            border-radius: var(--border-radius);
            margin: 30px 0;
        }

        .welcome h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .welcome p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 30px;
            color: #ddd;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: var(--dark);
            padding: 12px 30px;
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
        }

        .btn:disabled {
            background-color: var(--gray-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Información de contacto */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background-color: var(--gray);
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }

        .info-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-link {
            color: var(--light);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .contact-link:hover {
            color: var(--primary);
        }

        .contact-link.whatsapp:hover {
            color: #25D366;
        }

        .contact-link.instagram:hover {
            color: #E4405F;
        }

        .barbero-description {
            background-color: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-left: 3px solid var(--primary);
        }

        /* Calendario y horarios */
        .calendar-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: space-between;
        }

        .calendar-container {
            flex: 1;
            min-width: 300px;
        }

        .hours-container {
            flex: 1;
            min-width: 300px;
            background-color: var(--gray);
            padding: 25px;
            border-radius: var(--border-radius);
        }

        .calendar {
            background-color: var(--gray);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary);
            color: var(--dark);
            padding: 15px;
            font-weight: bold;
        }

        .calendar-days,
        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--gray-light);
        }

        .calendar-day {
            padding: 15px;
            text-align: center;
            background-color: var(--gray);
            font-weight: bold;
        }

        .calendar-date {
            padding: 15px;
            text-align: center;
            background-color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-date:hover {
            background-color: var(--gray-light);
        }

        .calendar-date.selected {
            background-color: var(--primary);
            color: var(--dark);
            font-weight: bold;
        }

        .calendar-date.disabled {
            background-color: var(--darker);
            color: #666;
            cursor: not-allowed;
        }

        .hours-list {
            margin-top: 20px;
        }

        .hour-option {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--dark);
            margin: 5px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--gray-light);
        }

        .hour-option:hover {
            border-color: var(--primary);
        }

        .hour-option.selected {
            background-color: var(--primary);
            color: var(--dark);
            font-weight: bold;
        }

        .hour-option.disabled {
            background-color: var(--darker);
            color: #666;
            cursor: not-allowed;
            border-color: var(--darker);
        }

   /* ========== SERVICIOS CON BOTÓN LEER MÁS ========== */
.services {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1200px;
    margin: 0 auto;
}

.service-card {
    background-color: var(--gray);
    padding: 25px;
    border-radius: var(--border-radius);
    transition: var(--transition);
    border: 2px solid transparent;
    min-height: 240px; /* Cambié de height a min-height */
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Efecto hover elegante */
.service-card:hover {
    border-color: var(--primary);
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
}

/* Línea decorativa superior */
.service-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

/* Nombre del servicio */
.service-name {
    color: var(--primary);
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 15px;
    line-height: 1.3;
    flex-shrink: 0;
}

/* Descripción con altura controlada */
.service-description {
    color: #ccc;
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 15px;
    flex-grow: 1;
    overflow: hidden;
    position: relative;
}

/* Cuando la descripción es corta, no mostrar el gradiente */
.service-description.short {
    max-height: none;
    -webkit-line-clamp: unset;
}

/* Cuando la descripción es larga, mostrar gradiente y botón */
.service-description.long {
    max-height: 72px; /* Aprox 3 líneas */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
    overflow: hidden;
}

/* Botón Leer más/menos */
.read-more-btn {
    background: transparent;
    color: var(--primary);
    border: 1px solid var(--primary);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: var(--transition);
    margin-top: 10px;
    align-self: flex-start;
    display: inline-block;
}

.read-more-btn:hover {
    background-color: var(--primary);
    color: var(--dark);
}

/* Precio - posición fija abajo */
.service-price {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--light);
    text-align: right;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative;
}

/* Efecto dorado en precio */
.service-price::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 60px;
    height: 2px;
    background: var(--primary);
}

/* Indicador de servicio (icono) */
.service-card::after {
    content: '✂️';
    position: absolute;
    bottom: 15px;
    left: 25px;
    font-size: 1.5rem;
    opacity: 0.1;
    z-index: 0;
}

/* Contenedor de descripción y botón */
.description-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

/* Responsive */
@media (max-width: 1024px) {
    .services {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }
    
    .service-card {
        padding: 20px;
    }
    
    .service-description.long {
        max-height: 68px;
    }
}

@media (max-width: 768px) {
    .services {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .service-card {
        padding: 18px;
    }
    
    .service-name {
        font-size: 1.2rem;
    }
    
    .service-price {
        font-size: 1.6rem;
    }
    
    .service-description.long {
        max-height: 64px;
    }
}

@media (max-width: 576px) {
    .services {
        grid-template-columns: 1fr;
        max-width: 400px;
    }
    
    .service-description.long {
        max-height: 84px; /* Más líneas en móvil */
        -webkit-line-clamp: 4;
    }
}

        /* Formulario de reserva */
        .reservation-form {
            background-color: var(--gray);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--dark);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            color: var(--light);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 250px;
        }

        .reservation-summary {
            background-color: var(--dark);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-left: 4px solid var(--primary);
        }

        /* Modal de confirmación */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--gray);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .modal-info {
            margin-bottom: 15px;
        }

        .modal-info strong {
            color: var(--primary);
            display: inline-block;
            width: 120px;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: block;
            text-align: center;
            font-weight: bold;
            margin-top: 20px;
            transition: var(--transition);
        }

        .whatsapp-btn:hover {
            background-color: #1da851;
        }

        .copy-btn {
            background-color: var(--dark);
            color: var(--light);
            border: 1px solid var(--gray-light);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .copy-btn:hover {
            border-color: var(--primary);
        }

        .close-btn {
            background-color: transparent;
            color: var(--light);
            border: 1px solid var(--gray-light);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: var(--transition);
        }

        .close-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Reportar problemas */
        .report-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--darker);
            padding: 15px;
            border-top: 1px solid var(--gray);
            z-index: 1000;
        }

        .report-toggle {
            background-color: var(--primary);
            color: var(--dark);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .report-form {
            max-width: 500px;
            margin: 20px auto 0;
            background-color: var(--gray);
            padding: 20px;
            border-radius: var(--border-radius);
            display: none;
        }

        .report-form.active {
            display: block;
        }

        .capture-btn {
            background-color: var(--dark);
            color: var(--light);
            border: 1px solid var(--gray-light);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: bold;
            z-index: 10000;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--error);
        }

        .notification.info {
            background-color: var(--primary);
            color: var(--dark);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Control de visibilidad de páginas */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cargando */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo h1 {
                font-size: 2rem;
            }

            .welcome h2 {
                font-size: 1.8rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .calendar-section {
                flex-direction: column;
            }

            .info-cards {
                grid-template-columns: 1fr;
            }
        }

        /* ========== VENTANA DE CONFIRMACIÓN NUEVA ========== */
        .confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }

        .confirmation-modal-overlay.active {
            display: flex !important;
        }

        .confirmation-window {
            background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            border: 3px solid transparent;
            box-shadow:
                0 0 50px rgba(212, 175, 55, 0.4),
                0 0 100px rgba(212, 175, 55, 0.2),
                inset 0 0 30px rgba(212, 175, 55, 0.1);
            animation: slideUp 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        /* Efecto borde dorado brillante */
        .confirmation-window::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg,
                    #d4af37,
                    #b8941f,
                    #ffd700,
                    #d4af37);
            border-radius: 23px;
            z-index: -1;
            opacity: 0.7;
            animation: borderGlow 3s infinite linear;
        }

        @keyframes borderGlow {
            0% {
                background-position: 0% 50%;
                opacity: 0.7;
            }

            50% {
                background-position: 100% 50%;
                opacity: 1;
            }

            100% {
                background-position: 0% 50%;
                opacity: 0.7;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Título con efecto neón */
        .confirmation-title {
            color: #d4af37;
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 30px;
            text-shadow:
                0 0 15px rgba(212, 175, 55, 0.5),
                0 0 25px rgba(212, 175, 55, 0.3),
                0 0 35px rgba(212, 175, 55, 0.1);
            letter-spacing: 1.5px;
            font-weight: 700;
            animation: titleGlow 2s infinite alternate;
        }

        @keyframes titleGlow {
            from {
                text-shadow:
                    0 0 15px rgba(212, 175, 55, 0.5),
                    0 0 25px rgba(212, 175, 55, 0.3);
            }

            to {
                text-shadow:
                    0 0 20px rgba(212, 175, 55, 0.7),
                    0 0 30px rgba(212, 175, 55, 0.4),
                    0 0 40px rgba(212, 175, 55, 0.2);
            }
        }

        /* Lista de información */
        .confirmation-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #d4af37;
            backdrop-filter: blur(10px);
        }

        .confirmation-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .confirmation-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .confirmation-label {
            color: #d4af37;
            font-weight: 600;
            min-width: 130px;
            font-size: 1.1rem;
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.3);
        }

        .confirmation-value {
            color: white;
            font-size: 1.2rem;
            flex: 1;
            font-weight: 500;
        }

        .confirmation-value.total {
            color: #d4af37 !important;
            font-weight: bold;
            font-size: 1.4rem;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
        }

        /* Botones */
        .confirmation-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .confirmation-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: none;
            outline: none;
        }

        .whatsapp-confirm {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-confirm:hover {
            background: linear-gradient(135deg, #1da851, #0d796e);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }

        .close-confirm {
            background: rgba(212, 175, 55, 0.15);
            color: white;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .close-confirm:hover {
            background: rgba(212, 175, 55, 0.25);
            border-color: #d4af37;
            transform: translateY(-3px);
        }

        /* Nota */
        .confirmation-note {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-style: italic;
        }

        /* Efectos de neón mejorados para botones */
        .whatsapp-confirm {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow:
                0 0 15px rgba(37, 211, 102, 0.5),
                0 0 30px rgba(37, 211, 102, 0.3),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
            border: 2px solid #25D366;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .whatsapp-confirm::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                    #25D366, #128C7E, #25D366);
            z-index: -1;
            border-radius: 10px;
            opacity: 0.8;
            animation: whatsappGlow 2s infinite alternate;
        }

        @keyframes whatsappGlow {
            0% {
                box-shadow: 0 0 10px rgba(37, 211, 102, 0.5);
                opacity: 0.7;
            }

            100% {
                box-shadow: 0 0 20px rgba(37, 211, 102, 0.8);
                opacity: 1;
            }
        }

        .close-confirm {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            box-shadow:
                0 0 15px rgba(255, 68, 68, 0.5),
                0 0 30px rgba(255, 68, 68, 0.3),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
            border: 2px solid #ff4444;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .close-confirm::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                    #ff4444, #cc0000, #ff4444);
            z-index: -1;
            border-radius: 10px;
            opacity: 0.8;
            animation: closeGlow 2s infinite alternate;
        }

        @keyframes closeGlow {
            0% {
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
                opacity: 0.7;
            }

            100% {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.8);
                opacity: 1;
            }
        }

        /* Efectos hover mejorados */
        .whatsapp-confirm:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 0 20px rgba(37, 211, 102, 0.7),
                0 0 40px rgba(37, 211, 102, 0.5),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .close-confirm:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 0 20px rgba(255, 68, 68, 0.7),
                0 0 40px rgba(255, 68, 68, 0.5),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Mejorar bordes dorados del modal */
        .confirmation-window::before {
            animation: borderGlow 3s infinite linear;
            background: linear-gradient(45deg,
                    #d4af37, #ffd700, #b8941f, #ffd700, #d4af37);
            background-size: 200% 200%;
        }

        @keyframes borderGlow {
            0% {
                background-position: 0% 50%;
                opacity: 0.8;
            }

            50% {
                background-position: 100% 50%;
                opacity: 1;
            }

            100% {
                background-position: 0% 50%;
                opacity: 0.8;
            }
        }

        /* Animaciones */

        @keyframes slideUp {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Agrega esto en tu CSS */
        .form-control.valid {
            border-color: var(--success) !important;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .form-control.invalid {
            border-color: var(--error) !important;
            box-shadow: 0 0 5px rgba(244, 67, 54, 0.3);
        }

        /* Indicador de validación */
        .form-group {
            position: relative;
        }

        .form-group .validation-icon {
            position: absolute;
            right: 10px;
            top: 35px;
            font-size: 1.2rem;
            display: none;
        }

        .form-group .validation-icon.valid {
            color: var(--success);
            display: block;
        }

        .form-group .validation-icon.invalid {
            color: var(--error);
            display: block;
        }

        /* ========== VENTANA DE OFERTAS ========== */
        .oferta-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999999;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .oferta-modal-overlay.active {
            display: flex !important;
        }

        .oferta-modal {
            background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            border: 4px solid transparent;
            box-shadow:
                0 0 60px rgba(255, 68, 68, 0.6),
                0 0 120px rgba(255, 68, 68, 0.3),
                inset 0 0 40px rgba(255, 68, 68, 0.1);
            animation: slideUpOferta 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        /* Efecto borde rojo brillante */
        .oferta-modal::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg,
                    #ff4444,
                    #ff0000,
                    #ff8800,
                    #ff4444);
            border-radius: 24px;
            z-index: -1;
            opacity: 0.8;
            animation: borderGlowOferta 2s infinite linear;
        }

        @keyframes borderGlowOferta {
            0% {
                background-position: 0% 50%;
                opacity: 0.8;
            }

            50% {
                background-position: 100% 50%;
                opacity: 1;
            }

            100% {
                background-position: 0% 50%;
                opacity: 0.8;
            }
        }

        @keyframes slideUpOferta {
            from {
                transform: translateY(40px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Título de oferta */
        .oferta-titulo {
            color: #ff4444;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow:
                0 0 20px rgba(255, 68, 68, 0.7),
                0 0 40px rgba(255, 68, 68, 0.4),
                0 0 60px rgba(255, 68, 68, 0.2);
            letter-spacing: 2px;
            font-weight: 800;
            animation: tituloOfertaGlow 1.5s infinite alternate;
        }

        @keyframes tituloOfertaGlow {
            from {
                text-shadow:
                    0 0 20px rgba(255, 68, 68, 0.7),
                    0 0 40px rgba(255, 68, 68, 0.4);
            }

            to {
                text-shadow:
                    0 0 30px rgba(255, 68, 68, 0.9),
                    0 0 50px rgba(255, 68, 68, 0.6),
                    0 0 70px rgba(255, 68, 68, 0.3);
            }
        }

        /* Subtítulo */
        .oferta-subtitulo {
            color: #ff9900;
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* Contenido de oferta */
        .oferta-contenido {
            background: rgba(255, 68, 68, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #ff4444;
            backdrop-filter: blur(10px);
        }

        .oferta-descripcion {
            color: white;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Precios */
        .precios-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 25px 0;
        }

        .precio-oferta {
            text-align: center;
        }

        .precio-oferta-titulo {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .precio-oferta-valor {
            color: #25D366;
            font-size: 2.8rem;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(37, 211, 102, 0.5);
        }

        .precio-normal {
            text-align: center;
            position: relative;
        }

        .precio-normal-titulo {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .precio-normal-valor {
            color: #888;
            font-size: 1.8rem;
            font-weight: 600;
            position: relative;
        }

        .precio-normal-valor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -5px;
            right: -5px;
            height: 3px;
            background: #ff4444;
            transform: rotate(-5deg);
        }

        /* Ahorro */
        .ahorro-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(37, 211, 102, 0.1);
            border-radius: 10px;
            border: 2px solid #25D366;
        }

        .ahorro-texto {
            color: #25D366;
            font-size: 1.4rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(37, 211, 102, 0.3);
        }

        /* Botones de oferta */
        .oferta-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .oferta-btn {
            flex: 1;
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: none;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .aceptar-oferta {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow:
                0 8px 25px rgba(37, 211, 102, 0.4),
                0 0 30px rgba(37, 211, 102, 0.3);
            border: 2px solid #25D366;
        }

        .aceptar-oferta:hover {
            background: linear-gradient(135deg, #1da851, #0d796e);
            transform: translateY(-3px) scale(1.03);
            box-shadow:
                0 12px 35px rgba(37, 211, 102, 0.6),
                0 0 40px rgba(37, 211, 102, 0.4);
        }

        .cerrar-oferta {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            box-shadow:
                0 8px 25px rgba(255, 68, 68, 0.4),
                0 0 30px rgba(255, 68, 68, 0.3);
            border: 2px solid #ff4444;
        }

        .cerrar-oferta:hover {
            background: linear-gradient(135deg, #cc3333, #990000);
            transform: translateY(-3px) scale(1.03);
            box-shadow:
                0 12px 35px rgba(255, 68, 68, 0.6),
                0 0 40px rgba(255, 68, 68, 0.4);
        }

        /* Nota de oferta */
        .oferta-nota {
            text-align: center;
            color: #888;
            font-size: 0.8rem;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-style: italic;
        }

     .calendar-extra-controls {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    padding: 0 15px;
}

.calendar-extra-controls button {
    background: var(--primary);
    color: var(--dark);
    border: 2px solid var(--primary);
    padding: 10px 25px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 0.95rem;
    transition: var(--transition);
    width: 100%;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.calendar-extra-controls button:hover {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.calendar-extra-controls button:active {
    transform: translateY(0);
}

/* ========== BOTONES DE FLECHA CLAROS Y VISIBLES ========== */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: var(--primary);
    color: var(--dark);
    padding: 15px 20px;
    font-weight: bold;
    position: relative;
}

.calendar-header button {
    background: var(--dark);
    color: var(--primary);
    border: 3px solid var(--dark);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
}

/* Contorno dorado para mejor visibilidad */
.calendar-header button {
    border: 3px solid var(--dark);
    outline: 2px solid var(--primary);
}

.calendar-header button i {
    color: var(--primary);
    font-weight: 900; /* Más grueso */
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.calendar-header button:hover {
    background: var(--primary);
    transform: scale(1.15);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
}

.calendar-header button:hover i {
    color: var(--dark);
    transform: scale(1.2);
}

/* Efecto de "pulsar" al hacer clic */
.calendar-header button:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
}

.calendar-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--dark);
    font-weight: 800;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.5px;
    text-align: center;
    flex-grow: 1;
    padding: 0 15px;
}

/* Mejora para el botón "Hoy" */
.calendar-extra-controls {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    padding: 0 20px;
}

.calendar-extra-controls button {
    background: var(--primary);
    color: var(--dark);
    border: 3px solid var(--dark);
    padding: 12px 30px;
    border-radius: 30px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 700;
    transition: all 0.3s ease;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.calendar-extra-controls button:hover {
    background: var(--dark);
    color: var(--primary);
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(212, 175, 55, 0.4);
}

.calendar-extra-controls button:active {
    transform: translateY(-1px);
}

/* Responsive */
@media (max-width: 768px) {
    .calendar-header {
        padding: 12px 15px;
    }
    
    .calendar-header button {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
    }
    
    .calendar-header h3 {
        font-size: 1.3rem;
    }
    
    .calendar-extra-controls button {
        padding: 10px 25px;
        font-size: 0.95rem;
    }
}

@media (max-width: 480px) {
    .calendar-header {
        padding: 10px 12px;
    }
    
    .calendar-header button {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        border-width: 2px;
    }
    
    .calendar-header h3 {
        font-size: 1.1rem;
        padding: 0 10px;
    }
    
    .calendar-extra-controls {
        padding: 0 15px;
    }
    
    .calendar-extra-controls button {
        padding: 8px 20px;
        font-size: 0.9rem;
    }
}

/* Indicador visual de que son botones clicables */
.calendar-header button {
    cursor: pointer;
}

/* Mejora la accesibilidad - focus states */
.calendar-header button:focus {
    outline: 3px solid #fff;
    outline-offset: 2px;
}

/* ========== FLECHAS SIMPLES PARA CALENDARIO ========== */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: var(--primary);
    color: var(--dark);
    padding: 15px;
    font-weight: bold;
}

/* Botones como flechas de texto */
.calendar-header button {
    background: transparent;
    color: var(--dark);
    border: none;
    font-size: 2rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
}

/* Usar emojis o caracteres especiales para las flechas */
.calendar-header button span {
    display: block;
    font-size: 2rem;
    line-height: 1;
    transition: transform 0.2s ease;
}

.calendar-header button:hover span {
    transform: scale(1.3);
}

.calendar-header button:active span {
    transform: scale(0.9);
}

.calendar-header h3 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--dark);
    font-weight: bold;
}

/* Botón "Hoy" más simple */
.calendar-extra-controls {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    padding: 0 15px;
}

.calendar-extra-controls button {
    background: rgba(0, 0, 0, 0.2);
    color: var(--light);
    border: none;
    padding: 10px 25px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.9rem;
    transition: var(--transition);
    width: 100%;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.calendar-extra-controls button:hover {
    background: rgba(0, 0, 0, 0.3);
}

.calendar-extra-controls button i {
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
    .calendar-header button {
        font-size: 1.8rem;
        width: 35px;
        height: 35px;
    }
    
    .calendar-header h3 {
        font-size: 1.2rem;
    }
    
    .calendar-extra-controls button {
        padding: 8px 20px;
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .calendar-header button {
        font-size: 1.6rem;
        width: 30px;
        height: 30px;
    }
    
    .calendar-header h3 {
        font-size: 1.1rem;
    }
    
    .calendar-extra-controls button {
        padding: 7px 15px;
        font-size: 0.8rem;
    }
}

/* Agrega esto en tu sección CSS */
#reservation:target {
    animation: highlightReservation 2s ease;
}

@keyframes highlightReservation {
    0% {
        box-shadow: 0 0 0 rgba(212, 175, 55, 0);
    }
    50% {
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
    }
    100% {
        box-shadow: 0 0 0 rgba(212, 175, 55, 0);
    }
}

/* Indicador de sincronización en tiempo real */
.sync-indicator {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 40px;
    height: 40px;
    background-color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0.8;
}

.sync-indicator:hover {
    opacity: 1;
    transform: scale(1.1);
}

.sync-indicator.syncing {
    animation: pulse 1.5s infinite;
}

.sync-indicator i {
    color: var(--dark);
    font-size: 1.2rem;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(212, 175, 55, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(212, 175, 55, 0);
    }
}

/* Estilos para el botón de actualización */
#forceRefreshBtn {
    background: rgba(212, 175, 55, 0.2);
    color: var(--light);
    border: 1px solid var(--primary);
    padding: 8px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.9rem;
    transition: var(--transition);
    width: 100%;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
}

#forceRefreshBtn:hover {
    background: rgba(212, 175, 55, 0.3);
    border-color: var(--primary-dark);
}

#forceRefreshBtn:active {
    transform: scale(0.98);
}

/* Mejorar visualización de horas disponibles */
.hour-option.available {
    cursor: pointer !important;
    transition: all 0.3s ease;
}

.hour-option.available:hover {
    background-color: rgba(212, 175, 55, 0.2) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.hour-option.selected {
    background-color: var(--primary) !important;
    color: var(--dark) !important;
    font-weight: bold;
}

/* ========== SCROLL SIMPLE PARA HORARIOS EN MÓVIL ========== */
@media (max-width: 768px) {
    .hours-list {
        max-height: 250px; /* Altura máxima fija para móviles */
        overflow-y: auto; /* Habilitar scroll vertical */
        padding-right: 5px; /* Espacio para el scrollbar */
    }
    
    /* Personalizar el scrollbar */
    .hours-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .hours-list::-webkit-scrollbar-track {
        background: var(--dark);
        border-radius: 3px;
    }
    
    .hours-list::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }
    
    .hours-list::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }
    
    /* Para Firefox */
    .hours-list {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) var(--dark);
    }
}

/* Indicador visual de que hay más contenido (opcional) */
@media (max-width: 768px) {
    .hours-container {
        position: relative;
    }
    
    .hours-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(to top, var(--gray), transparent);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    /* Mostrar gradiente cuando el contenido es más alto que el contenedor */
    .hours-container.scroll-available::after {
        opacity: 0.8;
    }
}
    </style>
<body>
    <!-- Header con logo -->
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-cut"></i>
                <h1>A.S. Studio</h1>
            </div>
            <p class="tagline">Barbería profesional - Un único barbero, máxima atención</p>

            <!-- Navegación entre páginas -->
            <div class="page-nav">
                <button class="page-btn active" id="btnMainPage">
                    <i class="fas fa-home"></i> Página Principal
                </button>
                <button class="page-btn" id="btnReservationPage">
                    <i class="fas fa-calendar-alt"></i> Reservar Turno
                </button>
            </div>
        </div>
    </header>

    <!-- Página Principal -->
    <main class="container">
        <div id="mainPage" class="page active">
            <!-- Sección de bienvenida -->
            <section class="welcome">
                <h2>Bienvenido a A.S. Studio</h2>
                <p>Experimenta el arte de la barbería tradicional con un toque moderno. Reserva tu turno para recibir un
                    servicio personalizado de la más alta calidad.</p>
                <button class="btn" id="goToReservationBtn">
                    <i class="fas fa-calendar-alt"></i> Reservar Turno
                </button>
            </section>

<section id="services">
    <h2 class="section-title">Servicios y Precios</h2>
    <div class="services">
        <div class="service-card">
            <h3 class="service-name">Barba</h3>
            <div class="description-container">
                <div class="service-description short" id="desc1">
                    Diseño, mantenimiento y forma, es lo que le demos a tu maquillaje varonil
                </div>
                <button class="read-more-btn" onclick="toggleDescription('desc1', this)" style="display: none;">
                    Leer más
                </button>
            </div>
            <p class="service-price">$7.000</p>
        </div>
        <div class="service-card">
            <h3 class="service-name">Corte de Cabello</h3>
            <div class="description-container">
                <div class="service-description short" id="desc2">
                    Corte tradicional o moderno, según tu preferencia
                </div>
                <button class="read-more-btn" onclick="toggleDescription('desc2', this)" style="display: none;">
                    Leer más
                </button>
            </div>
            <p class="service-price">$15.000</p>
        </div>
        <div class="service-card">
            <h3 class="service-name">Pestañas</h3>
            <div class="description-container">
                <div class="service-description short" id="desc3">
                    ¿No te dan bolas lo wachos? te hago las pestañas con el pelo del chivo y quedaras como una princesa
                </div>
                <button class="read-more-btn" onclick="toggleDescription('desc3', this)" style="display: none;">
                    Leer más
                </button>
            </div>
            <p class="service-price">$19.000</p>
        </div>
        <div class="service-card">
            <h3 class="service-name">Teñido de Mechas</h3>
            <div class="description-container">
                <div class="service-description short" id="desc4">
                    Selección de todos los tintes y asientos para una experiencia agradable
                </div>
                <button class="read-more-btn" onclick="toggleDescription('desc4', this)" style="display: none;">
                    Leer más
                </button>
            </div>
            <p class="service-price">$32.000</p>
        </div>
    </div>
</section>        

            <!-- Información de contacto -->
            <section id="info">
                <h2 class="section-title">Información de Contacto</h2>
                <div class="info-cards">
                    <div class="info-card">
                        <h3><i class="fas fa-map-marker-alt"></i> Dirección</h3>
                        <a href="https://www.google.com/maps/place/Int.+Alberto+Barzi+3231,+B1888+Florencio+Varela,+Provincia+de+Buenos+Aires/@-34.8124414,-58.2905572,79m/data=!3m1!1e3!4m6!3m5!1s0x95a32bdce01931d1:0x8f3c221ed55a3b39!8m2!3d-34.8124374!4d-58.2903754!16s%2Fg%2F11k64ymf22?entry=ttu&g_ep=EgoyMDI2MDEyOC4wIKXMDSoASAFQAw%3D%3D"
                            target="_blank" class="contact-link">
                            <i class="fas fa-external-link-alt"></i> Int. Alberto Barzi 3231, Florencio Varela
                            Ciudad
                        </a>
                        <p>Haz clic para ver en Google Maps</p>
                    </div>
                    <div class="info-card">
                        <h3><i class="fas fa-clock"></i> Horario de Atención</h3>
                        <p>Lunes a Viernes: 9:00 - 19:00<br>Sábados: 10:00 - 16:00<br>Domingos: Cerrado</p>
                        <button class="btn" id="goToCalendarBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-calendar-day"></i> Ver Calendario
                        </button>
                    </div>
                    <div class="info-card">
                        <h3><i class="fas fa-phone-alt"></i> Contacto</h3>
                        <a href="https://wa.me/1155739203" target="_blank" class="contact-link whatsapp">
                            <i class="fab fa-whatsapp"></i> +54 9 11 5573-9203
                        </a>
                        <a href="https://www.instagram.com/alexis.sebastiann?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw=="
                            target="_blank" class="contact-link instagram">
                            <i class="fab fa-instagram"></i> @alexis.sebastiann
                        </a>
                        <div class="barbero-description">
                            <p><strong>Alexis</strong>, tu barbero profesional.</p>
                            <p>"Cada corte es una obra de arte. Espero tu visita para crear el estilo perfecto para ti."
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Página de Reserva -->
        <div id="reservationPage" class="page">
            <!-- Calendario y horarios -->
            <section id="schedule">
                <h2 class="section-title">Selecciona Fecha y Hora</h2>
                <div class="calendar-section">
                  <div class="calendar-container">
    <div class="calendar">
        <!-- CALENDARIO SIMPLIFICADO - REEMPLAZA LAS LÍNEAS ANTERIORES CON ESTO -->
<div class="calendar-header">
    <button id="prevMonthBtn" title="Mes anterior">
        <span>⬅️</span>
    </button>
    <h3 id="currentMonthDisplay">Febrero 2026</h3>
    <button id="nextMonthBtn" title="Mes siguiente">
        <span>➡️</span>
    </button>
</div>

<div class="calendar-extra-controls">
    <button id="todayBtn">
        <i class="fas fa-calendar-day"></i> Volver a Hoy
    </button>
</div>
        
        <div class="calendar-days">
            <div class="calendar-day">Dom</div>
            <div class="calendar-day">Lun</div>
            <div class="calendar-day">Mar</div>
            <div class="calendar-day">Mié</div>
            <div class="calendar-day">Jue</div>
            <div class="calendar-day">Vie</div>
            <div class="calendar-day">Sáb</div>
        </div>
        <div class="calendar-dates" id="calendarDates">
            <!-- Los días se generarán con JavaScript -->
        </div>
    </div>
</div>
                  
                  

                    <div class="hours-container">
                        <h3>Horarios disponibles</h3>
                        <p id="selectedDateText">Selecciona una fecha en el calendario</p>
                        <div class="hours-list" id="hoursList">
                            <!-- Los horarios se generarán con JavaScript -->
                        </div>
                        <div class="info-card" style="margin-top: 20px;">
                            <h3><i class="fas fa-info-circle"></i> Importante</h3>
                            <p>No se pueden reservar dos turnos en el mismo día y horario. Cada cita tiene una duración
                                aproximada de 30-45 minutos.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Formulario de reserva -->
            <section id="reservation">
                <h2 class="section-title">Reserva tu Turno</h2>
                <div class="reservation-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientName">Nombre / Apodo *</label>
                            <input type="text" id="clientName" class="form-control"
                                placeholder="Ej: Juan o 'El Guille'">
                        </div>
                        <div class="form-group">
                            <label for="clientWhatsApp">Número de WhatsApp *</label>
                            <input type="tel" id="clientWhatsApp" class="form-control"
                                placeholder="Ej: 11 5573-9203 (sin +54)" pattern="[0-9]{2} [0-9]{4}-[0-9]{4}"
                                title="Formato: 11 1234-5678 (dos dígitos, espacio, cuatro dígitos, guión, cuatro dígitos)">
                            <small style="color: #aaa; font-size: 0.8rem;">Formato: 11 1234-5678</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="serviceSelect">Servicio *</label>
                        <select id="serviceSelect" class="form-control">
                            <option value="">Selecciona un servicio</option>
                            <option value="Corte de Cabello">Corte de Cabello - $2.500</option>
                            <option value="Corte + Barba">Corte + Barba - $3.200</option>
                            <option value="Arreglo de Barba">Arreglo de Barba - $1.800</option>
                            <option value="Afeitado Clásico">Afeitado Clásico - $2.200</option>
                        </select>
                    </div>

                    <div class="reservation-summary">
                        <h3>Resumen de tu Reserva</h3>
                        <p><strong>Fecha:</strong> <span id="summaryDate">No seleccionada</span></p>
                        <p><strong>Hora:</strong> <span id="summaryTime">No seleccionada</span></p>
                        <p><strong>Servicio:</strong> <span id="summaryService">No seleccionado</span></p>
                        <p><strong>Total:</strong> <span id="summaryPrice">$0</span></p>
                    </div>

                    <div class="form-group">
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 20px;">
                            * Al confirmar la reserva, deberás enviar un mensaje al barbero por WhatsApp para confirmar
                            tu turno.
                        </p>
                    </div>

                    <button type="button" class="btn" id="confirmReservationBtn"
                        style="width: 100%; padding: 15px; font-size: 1.1rem;">
                        <i class="fas fa-check-circle"></i> <span id="confirmText">Confirmar Reserva</span>
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- NUEVO MODAL DE CONFIRMACIÓN - REEMPLAZA COMPLETAMENTE -->
    <div class="confirmation-modal-overlay" id="newConfirmationModal">
        <div class="confirmation-window">
            <h2 class="confirmation-title">¡RESERVA CONFIRMADA!</h2>

            <div class="confirmation-info">
                <div class="confirmation-item">
                    <span class="confirmation-label">Cliente:</span>
                    <span class="confirmation-value" id="newModalClientName">-</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Contacto:</span>
                    <span class="confirmation-value" id="newModalWhatsApp">-</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Fecha:</span>
                    <span class="confirmation-value" id="newModalDate">-</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Hora:</span>
                    <span class="confirmation-value" id="newModalTime">-</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Servicio:</span>
                    <span class="confirmation-value" id="newModalService">-</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Total:</span>
                    <span class="confirmation-value total" id="newModalPrice">$0</span>
                </div>
            </div>

            <div class="confirmation-note">
                El barbero se contactará para confirmar la disponibilidad.
            </div>

            <div class="confirmation-actions">
                <button class="confirmation-btn whatsapp-confirm" id="newWhatsappConfirmBtn">
                    <i class="fab fa-whatsapp"></i> Confirmar por WhatsApp
                </button>
                <button class="confirmation-btn close-confirm" id="newCloseModalBtn">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Sección para reportar problemas -->
    <footer class="report-section">
        <button class="report-toggle" id="toggleReport">
            <i class="fas fa-exclamation-triangle"></i> Reportar un Problema
        </button>

        <div class="report-form" id="reportForm">
            <div class="form-group">
                <label for="problemDescription">Describe el problema *</label>
                <textarea id="problemDescription" class="form-control" rows="3"
                    placeholder="Detalla el problema que encontraste..."></textarea>
            </div>

            <button class="capture-btn" id="captureScreen">
                <i class="fas fa-camera"></i> Capturar Pantalla
            </button>

            <button class="btn" id="sendReport" style="margin-top: 15px; width: 100%;">
                <i class="fas fa-paper-plane"></i> Enviar Reporte
            </button>
        </div>
    </footer>

    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <!-- MODAL DE OFERTA ESPECIAL -->
<div class="oferta-modal-overlay" id="ofertaModal">
    <div class="oferta-modal">
        <h2 class="oferta-titulo">OFERTA ESPECIAL</h2>
        <p class="oferta-subtitulo">¡Oferta limitada!</p>
        
        <div class="oferta-contenido">
            <p class="oferta-descripcion">Corte de cabello + Afeitado clásico</p>
            
            <div class="precios-container">
                <div class="precio-oferta">
                    <div class="precio-oferta-titulo">PRECIO OFERTA</div>
                    <div class="precio-oferta-valor">$3.900</div>
                </div>
                
                <div class="precio-normal">
                    <div class="precio-normal-titulo">PRECIO NORMAL</div>
                    <div class="precio-normal-valor">$4.700</div>
                </div>
            </div>
            
            <div class="ahorro-container">
                <div class="ahorro-texto">¡AHORRA $800 (17%)!</div>
            </div>
        </div>
        
        <div class="oferta-actions">
            <button class="oferta-btn aceptar-oferta" id="aceptarOfertaBtn">
                <i class="fas fa-check-circle"></i> ACEPTAR OFERTA
            </button>
            <button class="oferta-btn cerrar-oferta" id="cerrarOfertaBtn">
                <i class="fas fa-times"></i> CERRAR
            </button>
        </div>
        
        <p class="oferta-nota">Oferta válida solo para nuevas reservas</p>
    </div>
</body>
    <script>     

window.servicePrices = {};
window.bookedSlots = {};
window.blockedHours = {};

// ========== VARIABLES GLOBALES CORREGIDAS ==========
let loadingBookedSlots = false;  // AGREGAR ESTO AL PRINCIPIO
let lastBookedSlotsLoad = 0;     // AGREGAR ESTO AL PRINCIPIO
let updateHoursTimeout = null;   // Para el debounce de actualización de horarios
let firebaseInitialized = false;
let eventListenersSet = false;
let loadingData = false;
let firebaseListenersInitialized = false;
let updatingHours = false;
let lastUpdateTime = 0;
const UPDATE_COOLDOWN = 1000;
let ofertaMostradaParaFechaHora = {}; 
let ofertaRechazadaParaFechaHora = {};

// Variables globales del calendario
let currentMonth = 1; // Febrero
let currentYear = 2026;
let selectedDate = null;
let calendarioInicializado = false;

// Variables de reserva
let db = null;
let selectedTime = null;
let selectedService = null;
let isSaving = false;
let bookedSlots = {};
let reservaEnProgreso = false; // Para evitar múltiples clics
let blockedHours = {};
let ofertaActiva = false;
let ofertaSeleccionada = false;
let procesandoOferta = false;
let ultimaSincronizacion = null;
let notificacionCambiosPendiente = false;

// 🔴 AGREGAR ESTAS VARIABLES DEBILBAWNER AQUÍ (ARRIBA DE TODO)
// window.bookedSlots = {};  // Ya está declarado arriba
// window.blockedHours = {}; // Ya está declarado arriba
// window.servicePrices = {}; // Declarar esto también si no está
window.servicePrices = window.servicePrices || {};

// Función para verificar la secuencia del calendario
function verificarSecuenciaCalendario() {
    console.log("🔍 VERIFICACIÓN DE SECUENCIA:");
    console.log("Mes actual:", window.currentMonth, `(${monthNames[window.currentMonth]})`);
    console.log("Año actual:", window.currentYear);
    
    console.log("Próximos 6 meses:");
    for (let i = 0; i < 6; i++) {
        let testMonth = window.currentMonth + i;
        let testYear = window.currentYear;
        
        // Ajustar año si pasamos de diciembre
        if (testMonth > 11) {
            testMonth = testMonth % 12;
            testYear += Math.floor((window.currentMonth + i) / 12);
        }
        
        console.log(`${i + 1}. ${monthNames[testMonth]} ${testYear}`);
    }
}

function forceCorrectCalendar() {
    console.log("🔧 Forzando secuencia correcta de calendario...");
    
    const now = new Date();

    // Verificar que estamos en el año correcto
    if (window.currentYear < 2020 || window.currentYear > 2030) {
        window.currentYear = now.getFullYear();
    }
    
    // Verificar que el mes sea válido
    if (window.currentMonth < 0 || window.currentMonth > 11) {
        window.currentMonth = now.getMonth();
    }
    
    console.log(`📆 Calendario configurado: ${monthNames[window.currentMonth]} ${window.currentYear}`);
    
    renderCalendar(window.currentMonth, window.currentYear);
}

// ========== SISTEMA DE CALENDARIO CORREGIDO Y SIN BUCLES ==========
const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

// Navegar al mes anterior - VERSIÓN COMPLETAMENTE CORREGIDA
function navegarMesAnterior() {
    console.log("=== NAVEGACIÓN MES ANTERIOR ===");
    console.log("ANTES - Mes:", currentMonth, `(${monthNames[currentMonth]})`, "Año:", currentYear);
    
    // CORRECCIÓN: Restar 1 al mes actual
    currentMonth--;
    
    // Si el mes es menor que 0 (antes de Enero), ir a Diciembre del año anterior
    if (currentMonth < 0) {
        currentMonth = 11; // Diciembre
        currentYear--;
    }
    
    console.log("DESPUÉS - Mes:", currentMonth, `(${monthNames[currentMonth]})`, "Año:", currentYear);
    
    // Actualizar variables globales
    window.currentMonth = currentMonth;
    window.currentYear = currentYear;
    
    renderizarCalendarioCompleto();
}

// Navegar al mes siguiente - VERSIÓN COMPLETAMENTE CORREGIDA
function navegarMesSiguiente() {
    console.log("=== NAVEGACIÓN MES SIGUIENTE ===");
    console.log("ANTES - Mes:", currentMonth, `(${monthNames[currentMonth]})`, "Año:", currentYear);
    
    // CORRECCIÓN: Sumar 1 al mes actual
    currentMonth++;
    
    // Si el mes es mayor que 11 (después de Diciembre), ir a Enero del año siguiente
    if (currentMonth > 11) {
        currentMonth = 0; // Enero
        currentYear++;
    }
    
    console.log("DESPUÉS - Mes:", currentMonth, `(${monthNames[currentMonth]})`, "Año:", currentYear);
    
    // Actualizar variables globales
    window.currentMonth = currentMonth;
    window.currentYear = currentYear;
    
    renderizarCalendarioCompleto();
}

// Ir al mes actual
function irAlMesActual() {
    console.log("📅 Yendo al mes ACTUAL del sistema");
    
    const ahora = new Date();
    currentMonth = ahora.getMonth(); // 0-11
    currentYear = ahora.getFullYear();
    
    console.log("NUEVO - Mes:", currentMonth, `(${monthNames[currentMonth]})`, "Año:", currentYear);
    
    // Actualizar variables globales
    window.currentMonth = currentMonth;
    window.currentYear = currentYear;
    
    renderizarCalendarioCompleto();
    showNotification('Volviendo al mes actual', 'info');
}

// Renderizar el calendario completo
function renderizarCalendarioCompleto() {
    console.log(`🎯 RENDERIZANDO CALENDARIO: ${monthNames[currentMonth]} ${currentYear} (índice: ${currentMonth})`);
    
    // 1. Actualizar encabezado
    const monthDisplay = document.getElementById('currentMonthDisplay');
    if (monthDisplay) {
        monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        console.log(`✅ Encabezado actualizado: ${monthNames[currentMonth]} ${currentYear}`);
    }
    
    // 2. Renderizar días
    renderizarDiasCalendario();
}

// Renderizar los días del calendario
function renderizarDiasCalendario() {
    const calendarDates = document.getElementById('calendarDates');
    if (!calendarDates) {
        console.error("❌ Elemento calendarDates no encontrado");
        return;
    }
    
    // Limpiar
    calendarDates.innerHTML = '';
    
    const year = currentYear;
    const month = currentMonth;
    
    // Obtener información del mes
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay(); // 0 = Domingo
    
    console.log(`📊 Días en ${monthNames[month]}: ${daysInMonth}, primer día: ${startingDay}`);
    
    // Días del mes anterior (para completar la primera semana)
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = 0; i < startingDay; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date disabled';
        dayElement.textContent = prevMonthLastDay - startingDay + i + 1;
        calendarDates.appendChild(dayElement);
    }
    
    // Días del mes actual
    const today = new Date();
    const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date';
        dayElement.textContent = day;
        
        const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        dayElement.dataset.date = dateStr;
        
        // Marcar si es hoy
        if (dateStr === todayFormatted) {
            dayElement.style.border = '2px solid var(--primary)';
        }
        
        // Marcar si está seleccionado
        if (window.selectedDate === dateStr) {
            dayElement.classList.add('selected');
        }
        
        // Verificar si es fecha futura o pasada
        const dateObj = new Date(year, month, day);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        if (dateObj >= hoy) {
            // Fecha futura o hoy - se puede seleccionar
            dayElement.addEventListener('click', function() {
                seleccionarFecha(dateStr);
            });
        } else {
            // Fecha pasada - deshabilitada
            dayElement.classList.add('disabled');
        }
        
        calendarDates.appendChild(dayElement);
    }
    
    // Rellenar días restantes (solo para completar la cuadrícula 6x7=42 celdas)
    const totalCells = 42;
    const remainingCells = totalCells - (startingDay + daysInMonth);
    for (let i = 1; i <= remainingCells; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date disabled';
        dayElement.textContent = i;
        calendarDates.appendChild(dayElement);
    }
}

// Función parseDate
function parseDate(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);
}

// ========== AGREGAR AL PRINCIPIO DE TU SCRIPT ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log("🚀 Iniciando aplicación...");
    
    // 1. Inicializar TODAS las variables globales
    window.selectedDate = null;
    window.selectedTime = null;
    window.selectedService = null;
    window.ofertaSeleccionada = false;
    window.bookedSlots = {};
    window.blockedHours = {};
    window.servicePrices = {};
    window.ofertasDisponibles = [];
    
    // 2. Inicializar calendario
    inicializarCalendarioSimple();
    
    // 3. Configurar eventos
    setupEventListeners();
    setupModalEvents();
    
    // 4. Inicializar Firebase
    setTimeout(() => {
        initializeFirebase();
    }, 1000);
    
    // 5. Limpiar formulario
    setTimeout(() => {
        limpiarFormularioCompleto();
        console.log("✅ Aplicación lista");
    }, 500);
});

// ========== AGREGAR ESTA FUNCIÓN DE PROTECCIÓN ==========
// Función para proteger contra asignaciones automáticas
function protegerVariablesGlobales() {
    // Hacer que las variables sean de solo lectura durante los primeros segundos
    Object.defineProperty(window, 'selectedDate', {
        writable: true,
        configurable: true,
        enumerable: true,
        value: null
    });
    
    Object.defineProperty(window, 'selectedTime', {
        writable: true,
        configurable: true,
        enumerable: true,
        value: null
    });
    
    Object.defineProperty(window, 'selectedService', {
        writable: true,
        configurable: true,
        enumerable: true,
        value: null
    });
    
    console.log("🛡️ Variables globales protegidas contra asignación automática");
}

// Llamar a la protección al inicio
protegerVariablesGlobales();

// ========== MODIFICAR LA FUNCIÓN inicializarCalendarioSimple ==========
function inicializarCalendarioSimple() {
    if (calendarioInicializado) {
        console.log("⏭️ Calendario ya inicializado, ignorando llamada duplicada");
        return;
    }
    
    console.log("📅 INICIALIZANDO CALENDARIO - UNA SOLA VEZ");
    calendarioInicializado = true;
    
    // 🔴 Asegurar que las variables estén vacías
    window.selectedDate = null;
    window.selectedTime = null;
    window.selectedService = null;
    
    // Configurar botones de navegación
    const prevBtn = document.getElementById('prevMonthBtn');
    const nextBtn = document.getElementById('nextMonthBtn');
    const todayBtn = document.getElementById('todayBtn');
    const monthDisplay = document.getElementById('currentMonthDisplay');
    
    if (!prevBtn || !nextBtn || !todayBtn || !monthDisplay) {
        console.error("❌ Elementos del calendario no encontrados");
        return;
    }
    
    // 🔴 VERIFICACIÓN DIAGNÓSTICA - Debe mostrar null
    console.log("=== DIAGNÓSTICO INICIAL ===");
    console.log("selectedDate:", window.selectedDate);
    console.log("selectedTime:", window.selectedTime);
    console.log("selectedService:", window.selectedService);
    console.log("=== FIN DIAGNÓSTICO ===");
    
    // Configurar eventos CORRECTAMENTE (solo una vez)
    prevBtn.onclick = function() {
        console.log("⬅️ CLICK: Botón Mes Anterior");
        navegarMesAnterior();
    };
    
    nextBtn.onclick = function() {
        console.log("➡️ CLICK: Botón Mes Siguiente");
        navegarMesSiguiente();
    };
    
    todayBtn.onclick = function() {
        console.log("📅 CLICK: Botón Hoy");
        irAlMesActual();
    };
    
    // Renderizar por primera vez
    renderizarCalendarioCompleto();
}

// ========== MODIFICAR LA FUNCIÓN seleccionarFecha ==========
function seleccionarFecha(dateStr) {
    console.log("📅 Fecha seleccionada:", dateStr);
    
    // 🔴 SOLO asignar cuando el usuario realmente hace clic
    window.selectedDate = dateStr;
    
    // 🔴 NUEVO: Limpiar registros de ofertas mostradas/rechazadas cuando cambia la fecha
    ofertaMostradaParaFechaHora = {};
    ofertaRechazadaParaFechaHora = {};
    
    // Resetear oferta si cambia la fecha
    if (ofertaSeleccionada) {
        ofertaSeleccionada = false;
        
        // Quitar la opción de oferta del selector
        const serviceSelect = document.getElementById('serviceSelect');
        if (serviceSelect) {
            const ofertaOption = serviceSelect.querySelector('option[value="Corte + Afeitado Especial"]');
            if (ofertaOption) {
                ofertaOption.remove();
            }
        }
    }
    
    // Marcar como seleccionada
    document.querySelectorAll('.calendar-date').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.date === dateStr) {
            el.classList.add('selected');
        }
    });
    
    // Actualizar texto
    const dateObj = parseDate(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const selectedDateText = document.getElementById('selectedDateText');
    if (selectedDateText) {
        selectedDateText.textContent = `Turnos disponibles para el ${dateObj.toLocaleDateString('es-ES', options)}`;
    }
    
    // Actualizar horarios
    if (typeof scheduleUpdateAvailableHours === 'function') {
        scheduleUpdateAvailableHours();
    }
    
    // 🔴 NUEVO: Hacer scroll a horarios disponibles en móviles
    setTimeout(() => {
        const hoursContainer = document.querySelector('.hours-container');
        if (hoursContainer && window.innerWidth <= 768) {
            hoursContainer.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
    }, 300);
    
    // 🔴 NO verificar oferta aquí - solo cuando se seleccione la hora
    console.log("✅ Fecha seleccionada, esperando hora para mostrar oferta");
}

// Agrega esta función para verificar si se necesita scroll
function verificarScrollHorarios() {
    const hoursList = document.getElementById('hoursList');
    const hoursContainer = document.querySelector('.hours-container');
    
    if (!hoursList || !hoursContainer || window.innerWidth > 768) return;
    
    // Verificar si el contenido es más alto que el contenedor
    if (hoursList.scrollHeight > hoursList.clientHeight) {
        hoursContainer.classList.add('scroll-available');
    } else {
        hoursContainer.classList.remove('scroll-available');
    }
}

// ========== MODIFICAR LA FUNCIÓN selectTime ==========
// Función para seleccionar hora - AGREGAR ESTA FUNCIÓN
function selectTime(timeStr) {
    console.log("🕐 selectTime llamado con:", timeStr);

     // 🔴 NUEVO: Limpiar registros de ofertas cuando se cambia la hora
    if (window.selectedTime !== timeStr) {
        console.log("🕐 Hora cambiada, limpiando registros de ofertas");
        ofertaMostradaParaFechaHora = {};
        ofertaRechazadaParaFechaHora = {};
    }
    
    // Validar que sea hora en punto (00 minutos)
    const minutos = timeStr.split(':')[1];
    if (minutos !== '00') {
        showNotification('⚠️ Las reservas son solo en horas en punto (ej: 11:00, 14:00)', 'info');
        return;
    }

    // 🔴 SOLO asignar cuando el usuario realmente hace clic
    window.selectedTime = timeStr;

    // Actualizar UI
    document.querySelectorAll('.hour-option').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.time === timeStr) {
            el.classList.add('selected');
        }
    });

    // Actualizar resumen
    updateReservationSummary();

    // Scroll al formulario si ya hay fecha seleccionada
    if (window.selectedDate) {
        scrollToReservationForm();
    }
    
    // 🔴 IMPORTANTE: Solo mostrar oferta cuando hay fecha Y hora
    setTimeout(() => {
        verificarYMostrarOferta();
    }, 100);
    
    console.log("⏰ Hora seleccionada:", timeStr);
}

// ========== AGREGAR LIMPIEZA DEL FORMULARIO ==========
function limpiarFormularioCompleto() {
    console.log("🧹 Limpiando formulario completo");
    
    // Limpiar campos
    document.getElementById('clientName').value = '';
    document.getElementById('clientWhatsApp').value = '';
    
    // Resetear selector de servicios
    const serviceSelect = document.getElementById('serviceSelect');
    if (serviceSelect) {
        serviceSelect.value = '';
        
        // Quitar opción de oferta si existe
        const ofertaOption = serviceSelect.querySelector('option[value="Corte + Afeitado Especial"]');
        if (ofertaOption) {
            ofertaOption.remove();
        }
    }
    
    // Resetear selecciones de UI
    document.querySelectorAll('.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Resetear variables
    window.selectedDate = null;
    window.selectedTime = null;
    window.selectedService = null;
    ofertaSeleccionada = false;
    
    // Actualizar UI
    updateReservationSummary();
    
    // Resetear texto de fecha
    const selectedDateText = document.getElementById('selectedDateText');
    if (selectedDateText) {
        selectedDateText.textContent = 'Selecciona una fecha en el calendario';
    }
    
    // Actualizar horarios
    if (typeof scheduleUpdateAvailableHours === 'function') {
        scheduleUpdateAvailableHours();
    }
    
    console.log("✅ Formulario limpiado");
}

// ========== LLAMAR LA LIMPIEZA AL CARGAR ==========
// Agregar al final de tu script
setTimeout(() => {
    limpiarFormularioCompleto();
    console.log("✅ Página cargada y formulario limpiado");
}, 1000);

// Función auxiliar para mostrar notificaciones
function showNotification(message, type = "info") {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = 'notification ' + type;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Inicializar blockedHours como objeto vacío
        window.blockedHours = window.blockedHours || {};

        // Función para inicializar TODO UNA SOLA VEZ
       async function initializeApp() {
       console.log("🚀 Iniciando aplicación...");

            // 1. Inicializar Firebase solo si no se ha hecho
            if (!firebaseInitialized) {
                await initializeFirebase();
                firebaseInitialized = true;
                console.log("✅ Firebase inicializado una sola vez");
            }

            // 2. Configurar eventos solo si no se ha hecho
            if (!eventListenersSet) {
                setupEventListeners();
                eventListenersSet = true;
                console.log("✅ Event listeners configurados una sola vez");
            }
        }

        // ========== CONFIGURACIÓN FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB3xCos-qTAOs8VIgcZk3ntUnPeI13YqR8",
            authDomain: "as-studio-d02c4.firebaseapp.com",
            projectId: "as-studio-d02c4",
            storageBucket: "as-studio-d02c4.firebasestorage.app",
            messagingSenderId: "1021827477452",
            appId: "1:1021827477452:web:4bd7fa03063720f1cdb769",
        };

        // Inicializar Firebase
        try {
            // Inicializar Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("✅ Firebase inicializado correctamente");
        } catch (error) {
            console.error("❌ Error inicializando Firebase:", error);
            // Modo demo si falla
        }

      async function loadServiciosFromFirebase() {
    if (!db) {
        loadDefaultServices();
        return;
    }

    try {
        const snapshot = await db.collection('servicios')
            .orderBy('precio', 'asc')
            .get();

        if (!snapshot.empty) {
            window.servicePrices = {};
            const services = [];

            snapshot.forEach(doc => {
                const servicio = doc.data();
                services.push(servicio);
                window.servicePrices[servicio.nombre] = servicio.precio;
            });

            // Actualizar selector de servicios en formulario
            actualizarSelectorServicios(services);
            
            // Actualizar tarjetas de servicios en página principal
            actualizarTarjetasServicios(services);
            
            console.log('✅ Servicios cargados:', services.length);

        } else {
            console.log('⚠️ No hay servicios en la base de datos');
            loadDefaultServices();
        }
    } catch (error) {
        console.error('❌ Error cargando servicios:', error);
        loadDefaultServices();
    }
}

// Función para actualizar selector de servicios
function actualizarSelectorServicios(services) {
    const serviceSelect = document.getElementById('serviceSelect');
    if (serviceSelect && services.length > 0) {
        // Guardar valor seleccionado actual
        const valorActual = serviceSelect.value;
        
        // Limpiar selector
        serviceSelect.innerHTML = '<option value="">Selecciona un servicio</option>';
        
        // Agregar servicios
        services.forEach(servicio => {
            const option = document.createElement('option');
            option.value = servicio.nombre;
            option.textContent = `${servicio.nombre} - $${servicio.precio.toLocaleString('es-AR')}`;
            option.dataset.precio = servicio.precio;
            serviceSelect.appendChild(option);
        });
        
        // Restaurar selección si todavía existe
        if (valorActual && serviceSelect.querySelector(`option[value="${valorActual}"]`)) {
            serviceSelect.value = valorActual;
        }
        
        // Si había una oferta seleccionada, restaurarla
        if (ofertaSeleccionada && window.selectedService) {
            const ofertaOption = serviceSelect.querySelector(`option[value="${window.selectedService}"]`);
            if (ofertaOption) {
                serviceSelect.value = window.selectedService;
            }
        }
    }
}

// Función para actualizar tarjetas de servicios
function actualizarTarjetasServicios(services) {
    const servicesSection = document.querySelector('.services');
    if (servicesSection && services.length > 0) {
        // Solo actualizar si estamos en la página principal
        if (document.getElementById('mainPage').classList.contains('active')) {
            servicesSection.innerHTML = '';
            
            services.forEach(servicio => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.innerHTML = `
                    <h3 class="service-name">${servicio.nombre}</h3>
                    <div class="description-container">
                        <div class="service-description short" id="desc-${servicio.nombre.replace(/\s+/g, '-')}">
                            ${servicio.descripcion || 'Servicio profesional'}
                        </div>
                        <button class="read-more-btn" onclick="toggleDescription('desc-${servicio.nombre.replace(/\s+/g, '-')}', this)" style="display: none;">
                            Leer más
                        </button>
                    </div>
                    <p class="service-price">$${servicio.precio.toLocaleString('es-AR')}</p>
                `;
                servicesSection.appendChild(serviceCard);
            });
            
            // Reconfigurar botones "Leer más"
            setTimeout(() => {
                checkDescriptionsLength();
            }, 100);
        }
    }
}

        async function saveReservationToFirebase(clientName, clientWhatsApp) {
            if (!db) {
                // VERIFICAR SI EL HORARIO ESTÁ BLOQUEADO POR ADMIN
                const blockedForDate = window.blockedHours[window.selectedDate] || [];
                if (blockedForDate.includes(window.selectedTime)) {
                    console.log('❌ Horario bloqueado por administrador');
                    return {
                        success: false,
                        message: 'Este horario no está disponible'
                    };
                }

                // Validar que sea hora en punto (00 minutos)
                const minutos = window.selectedTime.split(':')[1];
                if (minutos !== '00') {
                    return {
                        success: false,
                        message: 'Solo se permiten reservas en horas en punto (ej: 11:00, 14:00)'
                    };
                }

                // VERIFICAR SI EL DÍA ESTÁ COMPLETAMENTE BLOQUEADO
                if (window.blockedHours[window.selectedDate] === 'all') {
                    console.log('❌ Día bloqueado por administrador');
                    return {
                        success: false,
                        message: 'Este día no está disponible'
                    }
                };
            }

            try {
                const precio = window.servicePrices[window.selectedService] || 0;

                const reservationData = {
                    fecha: window.selectedDate,
                    hora: window.selectedTime,
                    servicio: window.selectedService,
                    nombre: clientName,
                    telefono: clientWhatsApp,
                    precio: precio,
                    estado: 'pendiente',
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                };

                // VERIFICACIÓN CRÍTICA: ¿Ya existe esta reserva?
                const existingQuery = await db.collection('turnos')
                    .where('fecha', '==', window.selectedDate)
                    .where('hora', '==', window.selectedTime)
                    .where('estado', 'in', ['pendiente', 'confirmado'])
                    .limit(1)
                    .get();

                if (!existingQuery.empty) {
                    console.log('❌ Ya existe una reserva para esta fecha y hora');
                    return {
                        success: false,
                        message: 'Este horario ya está reservado'
                    };
                }

                // Guardar solo si no existe
                const docRef = await db.collection('turnos').add(reservationData);
                console.log('✅ Reserva guardada en Firebase con ID:', docRef.id);

                // Agregar al array local INMEDIATAMENTE
                if (!window.bookedSlots[window.selectedDate]) {
                    window.bookedSlots[window.selectedDate] = [];
                }
                window.bookedSlots[window.selectedDate].push(window.selectedTime);

                return {
                    success: true,
                    data: { id: docRef.id, ...reservationData }
                };

            } catch (error) {
                console.error('💥 Error guardando en Firebase:', error);
                return {
                    success: false,
                    message: error.message
                };
            }
        }

        // Función para debuguear eventos
        function debugEventListeners() {
            console.log("🔍 DEBUG: Contando event listeners...");

            const confirmBtn = document.getElementById('confirmReservationBtn');
            if (confirmBtn) {
                console.log(`Botón confirmar tiene ${confirmBtn._clickListeners || 0} listeners`);
            }

            console.log("📊 Variables globales:", {
                selectedDate: window.selectedDate,
                selectedTime: window.selectedTime,
                selectedService: window.selectedService,
                bookedSlotsCount: Object.keys(window.bookedSlots || {}).length
            });
        }

        // Al inicio del script, agregar compatibilidad
        if (!document.execCommand && navigator.clipboard) {
            document.execCommand = function (command, showUI, value) {
                if (command === 'copy' && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(value).then(() => true);
                    return true;
                }
                return false;
            };
        }

        // 2. Precios de servicios
        window.servicePrices = {
            'Corte de Cabello': 2500,
            'Corte + Barba': 3200,
            'Arreglo de Barba': 1800,
            'Afeitado Clásico': 2200
        };

        // 3. Define TODAS las funciones primero
        async function confirmReservation() { /* código */ }
        function showNotification() { /* código */ }
        // ... todas las demás funciones ...
    
    // 1. Inicializar calendario PRIMERO
    setTimeout(() => {
        inicializarCalendarioSimple();
        console.log("✅ Calendario inicializado");
  
    // 2. Configurar otros eventos después
    setTimeout(() => {
        setupEventListeners();
        setupModalEvents();
        console.log("✅ Eventos configurados");
    }, 300);
    
    // 3. Inicializar Firebase después
    setTimeout(() => {
        initializeFirebase();
    }, 500);
})

        // ========== FUNCIONES FALTANTES ==========
        function checkIfDateFullyBooked(dateStr) {
    // Verificar que window.bookedSlots exista
    if (!window.bookedSlots || typeof window.bookedSlots !== 'object') {
        console.log('⚠️ bookedSlots no está inicializado');
        return false;
    }
    
    if (!window.bookedSlots[dateStr]) return false;
    
    const allHours = [];
    for (let hour = 9; hour <= 18; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
            if (hour === 18 && minute > 0) break;
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            allHours.push(timeStr);
        }
    }
    
    const bookedHours = window.bookedSlots[dateStr] || [];
    return allHours.every(hour => bookedHours.includes(hour));
}

function diagnosticarOfertas() {
    console.log("=== DIAGNÓSTICO DE OFERTAS ===");
    console.log("Ofertas disponibles:", window.ofertasDisponibles?.length || 0);
    
    if (window.ofertasDisponibles && window.ofertasDisponibles.length > 0) {
        window.ofertasDisponibles.forEach((oferta, index) => {
            console.log(`${index + 1}. ${oferta.nombre}`);
            console.log(`   Tipo: ${oferta.tipo_duracion || 'fecha/hora'}`);
            console.log(`   Precio: $${oferta.precio_oferta} (normal: $${oferta.precio_normal})`);
            console.log(`   Activa: ${oferta.activa}`);
            
            if (oferta.tipo_duracion === "horas") {
                console.log(`   Duración: ${oferta.duracion_horas} horas`);
                console.log(`   Creado: ${oferta.creado_en}`);
                if (oferta.creado_en) {
                    const creado = new Date(oferta.creado_en);
                    const fin = new Date(creado.getTime() + (oferta.duracion_horas * 60 * 60 * 1000));
                    console.log(`   Vence: ${fin}`);
                    console.log(`   ¿Aún válida?: ${new Date() <= fin}`);
                }
            } else {
                console.log(`   Inicio: ${oferta.inicio}`);
                console.log(`   Fin: ${oferta.fin}`);
            }
            console.log("---");
        });
    }
    
    console.log("Oferta activa global:", ofertaActiva);
    console.log("Oferta seleccionada:", ofertaSeleccionada);
    console.log("=== FIN DIAGNÓSTICO ===");
}

        function loadDefaultServices() {
            console.log('📦 Cargando servicios por defecto');
            window.servicePrices = {
                'Corte de Cabello': 2500,
                'Corte + Barba': 3200,
                'Arreglo de Barba': 1800,
                'Afeitado Clásico': 2200
            };
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function loadDemoData() {
            console.log('Cargando datos demo');
            window.bookedSlots = {};
            const hoy = new Date();

            for (let i = 0; i < 10; i++) {
                const fecha = new Date();
                fecha.setDate(hoy.getDate() + i);
                const fechaStr = formatDate(fecha);

                if (Math.random() > 0.5) {
                    window.bookedSlots[fechaStr] = [];
                    const horarios = ['09:00', '10:30', '14:00', '16:30'];
                    const cantidad = Math.floor(Math.random() * 3) + 1;

                    for (let j = 0; j < cantidad; j++) {
                        const horario = horarios[Math.floor(Math.random() * horarios.length)];
                        if (!window.bookedSlots[fechaStr].includes(horario)) {
                            window.bookedSlots[fechaStr].push(horario);
                        }
                    }
                }
            }
        }

        // ========== FUNCIÓN setupEventListeners ==========
        function setupEventListeners() {
            console.log("🛠️ Configurando eventos...");

            // Asegurar que el modal esté OCULTO al inicio
            const modal = document.getElementById('newConfirmationModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                console.log("✅ Modal oculto al inicio");
            }

            // Al inicio de setupEventListeners
            console.log("🔍 Variables globales al iniciar:", {
                selectedDate: window.selectedDate,
                selectedTime: window.selectedTime,
                selectedService: window.selectedService
            });

            if (btnMainPage && btnReservationPage && mainPage && reservationPage) {
                btnMainPage.addEventListener('click', function () {
                    mainPage.classList.add('active');
                    reservationPage.classList.remove('active');
                    btnMainPage.classList.add('active');
                    btnReservationPage.classList.remove('active');
                });

                btnReservationPage.addEventListener('click', function () {
                    reservationPage.classList.add('active');
                    mainPage.classList.remove('active');
                    btnReservationPage.classList.add('active');
                    btnMainPage.classList.remove('active');
                });
            }

            // Validación en tiempo real para WhatsApp
            const whatsappInput = document.getElementById('clientWhatsApp');
            if (whatsappInput) {
                whatsappInput.addEventListener('input', function (e) {
                    const valor = e.target.value;

                    // Permitir solo números, espacios y guiones
                    e.target.value = valor.replace(/[^\d\s-]/g, '');

                    // Auto-formatear mientras escribe
                    if (valor.replace(/\D/g, '').length >= 10) {
                        const numeroLimpio = valor.replace(/\D/g, '');
                        if (numeroLimpio.length === 10) {
                            // Formato: 11 1234-5678
                            const parte1 = numeroLimpio.substring(0, 2);
                            const parte2 = numeroLimpio.substring(2, 6);
                            const parte3 = numeroLimpio.substring(6, 10);
                            e.target.value = `${parte1} ${parte2}-${parte3}`;
                        }
                    }
                });

                // Validar al perder el foco
                whatsappInput.addEventListener('blur', function () {
                    const valor = this.value.trim();
                    if (valor) {
                        const validacion = validarWhatsApp(valor);
                        if (!validacion.valido) {
                            showNotification(`⚠️ ${validacion.mensaje}`, "error");
                            this.style.borderColor = "var(--error)";
                        } else {
                            this.style.borderColor = "var(--success)";
                            this.value = validacion.numeroFormateado;
                        }
                    }
                });
            }

            // Botón para ir a reservas desde la página principal
            const goToReservationBtn = document.getElementById('goToReservationBtn');
            if (goToReservationBtn) {
                goToReservationBtn.addEventListener('click', function () {
                    if (reservationPage && btnReservationPage) {
                        reservationPage.classList.add('active');
                        if (mainPage) mainPage.classList.remove('active');
                        btnReservationPage.classList.add('active');
                        if (btnMainPage) btnMainPage.classList.remove('active');
                    }
                });
            }

            // Botón para ir al calendario
            const goToCalendarBtn = document.getElementById('goToCalendarBtn');
            if (goToCalendarBtn) {
                goToCalendarBtn.addEventListener('click', function () {
                    if (reservationPage && btnReservationPage) {
                        reservationPage.classList.add('active');
                        if (mainPage) mainPage.classList.remove('active');
                        btnReservationPage.classList.add('active');
                        if (btnMainPage) btnMainPage.classList.remove('active');
                    }
                });
            }

            // En setupEventListeners, después de configurar otros eventos:
const forceRefreshBtn = document.getElementById('forceRefreshBtn');
if (forceRefreshBtn) {
    forceRefreshBtn.addEventListener('click', function() {
        if (window.selectedDate) {
            showNotification('🔄 Actualizando horarios...', 'info');
            updateAvailableHours();
        } else {
            showNotification('Selecciona una fecha primero', 'info');
        }
    });
}
        }

// Función para diagnóstico
function verificarEstadoCalendario() {
    console.log("=== VERIFICACIÓN DEL CALENDARIO ===");
    console.log(`1. Variables globales:`);
    console.log(`   window.currentMonth: ${window.currentMonth} (${monthNames[window.currentMonth]})`);
    console.log(`   window.currentYear: ${window.currentYear}`);
    
    const ahora = new Date();
    console.log(`2. Fecha del sistema:`);
    console.log(`   Mes real: ${ahora.getMonth()} (${monthNames[ahora.getMonth()]})`);
    console.log(`   Año real: ${ahora.getFullYear()}`);
    
    console.log(`3. Diferencia: ${window.currentMonth - ahora.getMonth()} meses`);
    console.log("=== FIN VERIFICACIÓN ===");
}

            // Selector de servicio
            const serviceSelect = document.getElementById('serviceSelect');
// En el evento change del selector de servicios:
// En el evento change del selector de servicios:
if (serviceSelect) {
    serviceSelect.addEventListener('change', function() {
        // Si se selecciona un servicio diferente a la oferta, resetear la oferta
        if (this.value !== "Corte + Afeitado Especial" && ofertaSeleccionada) {
            ofertaSeleccionada = false;
            console.log("Oferta deseleccionada al cambiar servicio");
            
            // 🔴 NUEVO: Si el usuario selecciona un servicio común después de rechazar oferta,
            // NO volver a mostrar la oferta
            if (window.selectedDate && window.selectedTime) {
                const claveOferta = `${window.selectedDate}_${window.selectedTime}`;
                ofertaRechazadaParaFechaHora[claveOferta] = true;
                console.log(`✅ Previniendo reaparición de oferta para: ${claveOferta}`);
            }
        }
        
        window.selectedService = this.value;
        console.log("✂️ Servicio seleccionado:", this.value);
        updateReservationSummary();
        
        // 🔴 IMPORTANTE: NO verificar oferta si el usuario ya rechazó una
        if (window.selectedDate && window.selectedTime && window.selectedService && ofertaActiva && !ofertaSeleccionada) {
            const claveOferta = `${window.selectedDate}_${window.selectedTime}`;
            
            if (!ofertaRechazadaParaFechaHora[claveOferta]) {
                console.log("✅ Servicio cambiado, verificando oferta...");
                setTimeout(() => {
                    verificarYMostrarOferta();
                }, 300);
            } else {
                console.log("⏭️ Oferta ya fue rechazada, no volver a mostrar");
            }
        }
    });
}

            // Botón de confirmación de reserva - CON PREVENCIÓN DE MÚLTIPLES CLICS
            const confirmReservationBtn = document.getElementById('confirmReservationBtn');
            if (confirmReservationBtn) {
                // Remover todos los listeners anteriores
                const newBtn = confirmReservationBtn.cloneNode(true);
                confirmReservationBtn.parentNode.replaceChild(newBtn, confirmReservationBtn);

                // Agregar nuevo listener al botón fresco
                document.getElementById('confirmReservationBtn').addEventListener('click', function (e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    console.log("🖱️ Botón clickeado - ÚNICO LISTENER");

                    // Verificar que la función exista
                    if (typeof window.confirmReservation === 'function') {
                        window.confirmReservation();
                    } else {
                        alert("Error: recarga la página");
                    }

                    return false;
                });
            }

            // Modal de confirmación
            const copyMessageBtn = document.getElementById('copyMessageBtn');
            if (copyMessageBtn) {
                copyMessageBtn.addEventListener('click', copyMessageToClipboard);
            }

            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }

            // Reportar problemas
            const toggleReportBtn = document.getElementById('toggleReport');
            const reportForm = document.getElementById('reportForm');

            if (toggleReportBtn && reportForm) {
                toggleReportBtn.addEventListener('click', function () {
                    reportForm.classList.toggle('active');
                });
            }

            const sendReportBtn = document.getElementById('sendReport');
            if (sendReportBtn) {
                sendReportBtn.addEventListener('click', sendReport);
            }

            console.log("✅ Todos los eventos configurados");

            // Configurar eventos de la nueva ventana de confirmación
            function setupModalEvents() {
                console.log("🔧 Configurando eventos del modal...");

                // Botón cerrar
                const closeBtn = document.getElementById('newCloseModalBtn');
                if (closeBtn) {
                    closeBtn.onclick = function () {
                        const modal = document.getElementById('newConfirmationModal');
                        if (modal) {
                            modal.classList.remove('active');
                            resetForm();
                        }
                    };
                }

                // Cerrar al hacer clic fuera del modal
                const modal = document.getElementById('newConfirmationModal');
                if (modal) {
                    modal.addEventListener('click', function (e) {
                        if (e.target === this) {
                            this.classList.remove('active');
                            resetForm();
                        }
                    });
                }

                // Cerrar con tecla ESC
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('newConfirmationModal');
                        if (modal && modal.classList.contains('active')) {
                            modal.classList.remove('active');
                            resetForm();
                        }
                    }
                });
            }
        
// Función específica para verificar ofertas (solo cuando se necesite)
function verificarYMostrarOferta() {
    console.log("🔍 VERIFICACIÓN DE OFERTA - Estado actual:");
    console.log("  - Fecha seleccionada:", window.selectedDate);
    console.log("  - Hora seleccionada:", window.selectedTime);
    console.log("  - Servicio seleccionado:", window.selectedService);
    console.log("  - Oferta activa:", ofertaActiva);
    console.log("  - Oferta ya seleccionada:", ofertaSeleccionada);
    console.log("  - Ofertas disponibles:", window.ofertasDisponibles ? window.ofertasDisponibles.length : 0);
    
    // 🔴 CONDICIÓN CRÍTICA: Solo mostrar si hay fecha Y hora seleccionadas
    if (!window.selectedDate || !window.selectedTime) {
        console.log("⏭️ Faltan fecha u hora para mostrar oferta");
        return false;
    }
    
    // 🔴 NUEVO: Crear clave única para esta fecha y hora
    const claveOferta = `${window.selectedDate}_${window.selectedTime}`;
    
    // 🔴 Verificar si ya se mostró oferta para esta fecha y hora
    if (ofertaMostradaParaFechaHora[claveOferta]) {
        console.log("⏭️ Oferta ya fue mostrada para esta fecha y hora");
        return false;
    }
    
    // 🔴 Verificar si el usuario ya rechazó oferta para esta fecha y hora
    if (ofertaRechazadaParaFechaHora[claveOferta]) {
        console.log("⏭️ Oferta ya fue rechazada para esta fecha y hora");
        return false;
    }
    
    if (!ofertaActiva) {
        console.log("⏭️ No hay ofertas activas");
        return false;
    }
    
    if (ofertaSeleccionada) {
        console.log("⏭️ Oferta ya fue seleccionada");
        return false;
    }
    
    // Verificar si hay ofertas disponibles
    if (!window.ofertasDisponibles || window.ofertasDisponibles.length === 0) {
        console.log("⏭️ No hay ofertas disponibles");
        return false;
    }
    
    console.log("🔍 Buscando oferta aplicable...");
    
    // Verificar TODAS las ofertas disponibles
    for (const oferta of window.ofertasDisponibles) {
        console.log(`🔍 Analizando oferta: ${oferta.nombre}`);
        console.log(`   Tipo: ${oferta.tipo_duracion || 'fecha/hora'}`);
        
        let esAplicable = true;
        
        // Para ofertas por horas, verificar si todavía están vigentes
        if (oferta.tipo_duracion === "horas" && oferta.duracion_horas) {
            console.log("   Es oferta por horas");
            
            if (oferta.creado_en) {
                const creadoEn = parseFirebaseDate(oferta.creado_en);
                
                if (creadoEn) {
                    const duracionMs = oferta.duracion_horas * 60 * 60 * 1000;
                    const finOferta = new Date(creadoEn.getTime() + duracionMs);
                    const ahora = new Date();
                    
                    console.log(`   Creado: ${creadoEn}`);
                    console.log(`   Duración: ${oferta.duracion_horas} horas`);
                    console.log(`   Vence: ${finOferta}`);
                    console.log(`   Ahora: ${ahora}`);
                    console.log(`   ¿Todavía válida?: ${ahora <= finOferta}`);
                    
                    esAplicable = (ahora <= finOferta);
                } else {
                    console.log("   ⚠️ No se pudo parsear fecha de creación");
                    esAplicable = false;
                }
            } else {
                console.log("   ⚠️ No tiene fecha de creación");
                esAplicable = false;
            }
        }
        // Para ofertas por fecha/hora, verificar si la fecha seleccionada está dentro del rango
        else if (oferta.inicio || oferta.fin) {
            console.log("   Es oferta con fechas límite");
            
            const inicio = parseFirebaseDate(oferta.inicio);
            const fin = parseFirebaseDate(oferta.fin);
            const ahora = new Date();
            
            console.log(`   Inicio: ${inicio}`);
            console.log(`   Fin: ${fin}`);
            console.log(`   Ahora: ${ahora}`);
            
            if (inicio && fin) {
                esAplicable = (ahora >= inicio && ahora <= fin);
                console.log(`   ¿Válida (entre fechas)?: ${esAplicable}`);
            } else if (inicio && !fin) {
                esAplicable = (ahora >= inicio);
                console.log(`   ¿Válida (desde inicio)?: ${esAplicable}`);
            } else if (!inicio && fin) {
                esAplicable = (ahora <= fin);
                console.log(`   ¿Válida (hasta fin)?: ${esAplicable}`);
            } else {
                // Sin fechas límite
                esAplicable = true;
                console.log("   Sin fechas límite, válida");
            }
        }
        // Para ofertas sin fecha límite, siempre aplicar
        else {
            console.log("   Oferta sin fecha límite, válida");
            esAplicable = true;
        }
        
        if (esAplicable) {
            console.log(`✅ Oferta APLICABLE: ${oferta.nombre}, mostrando modal...`);
            
            // 🔴 Registrar que ya mostramos oferta para esta fecha y hora
            ofertaMostradaParaFechaHora[claveOferta] = true;
            
            // 🔴 PEQUEÑO DELAY para mejor UX
            setTimeout(() => {
                mostrarModalOfertaEspecifica(oferta);
            }, 300);
            
            return true;
        } else {
            console.log(`❌ Oferta NO aplicable: ${oferta.nombre}`);
        }
    }
    
    console.log("⏭️ Ninguna oferta aplica para esta fecha/hora");
    return false;
}

// REEMPLAZA la función renderCalendar actual con esta versión CORREGIDA
function renderCalendar(month, year) {
    console.log(`🎯 RENDERIZANDO CALENDARIO - Mes: ${monthNames[month]} ${year} (índice: ${month})`);
    
    // Validar que el mes esté en el rango correcto (0-11)
    if (month < 0 || month > 11) {
        console.error(`❌ ERROR: Mes inválido: ${month}. Reseteando a mes actual.`);
        const now = new Date();
        month = now.getMonth();
        year = now.getFullYear();
    }
    
    // Asegurar que las variables globales estén correctas
    window.currentMonth = month;
    window.currentYear = year;
    
    // Actualizar el encabezado del mes
    const monthHeader = document.getElementById('currentMonth');
    if (monthHeader) {
        monthHeader.textContent = `${monthNames[month]} ${year}`;
        console.log(`✅ Encabezado actualizado: ${monthNames[month]} ${year}`);
    }
    
    // Obtener primer día del mes
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay(); // 0 = Domingo, 1 = Lunes...
    
    // Generar calendario
    const calendarDates = document.getElementById('calendarDates');
    if (!calendarDates) return;
    
    calendarDates.innerHTML = '';
    
    // Días del mes anterior (para completar la primera semana)
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = 0; i < startingDay; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date disabled';
        dayElement.textContent = prevMonthLastDay - startingDay + i + 1;
        calendarDates.appendChild(dayElement);
    }
    
    // Días del mes actual
    const today = new Date();
    const todayFormatted = formatDate(today);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date';
        dayElement.textContent = day;
        
        const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        dayElement.dataset.date = dateStr;
        
        // Verificar si es hoy
        if (dateStr === todayFormatted) {
            dayElement.style.border = '2px solid var(--primary)';
        }
        
        // Verificar si está seleccionado
        if (window.selectedDate === dateStr) {
            dayElement.classList.add('selected');
        }
        
        // Verificar si es fecha pasada
        const dateObj = new Date(year, month, day);
        if (dateObj < new Date().setHours(0, 0, 0, 0)) {
            dayElement.classList.add('disabled');
        } else {
            // Agregar evento click solo para fechas futuras
            dayElement.addEventListener('click', () => selectDate(dateStr));
        }
        
        calendarDates.appendChild(dayElement);
    }
    
    // Rellenar días restantes
    const totalCells = 42; // 6 semanas * 7 días
    const remainingCells = totalCells - (startingDay + daysInMonth);
    
    for (let i = 1; i <= remainingCells; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-date disabled';
        dayElement.textContent = i;
        calendarDates.appendChild(dayElement);
    }
    
    // Actualizar horarios disponibles si hay una fecha seleccionada
    if (window.selectedDate) {
        scheduleUpdateAvailableHours();
    }
}

function mostrarModalOfertaEspecifica(oferta) {
    console.log("🔧 [MOSTRAR MODAL OFERTA] Oferta recibida:", oferta);
    console.log("Datos completos:", JSON.stringify(oferta, null, 2));
    
    const ofertaModal = document.getElementById('ofertaModal');
    if (!ofertaModal) {
        console.error("❌ Modal no encontrado!");
        return;
    }

        // 🔴 OCULTAR TODO EL CONTENEDOR DEL CALENDARIO
    const calendarContainer = document.querySelector('.calendar-container');
    const hoursContainer = document.querySelector('.hours-container');
    if (calendarContainer) calendarContainer.style.opacity = '0.3';
    if (hoursContainer) hoursContainer.style.opacity = '0.3';
    
    // 🔴 CRÍTICO: Asegurar que tenemos datos válidos
    const nombre = oferta.nombre || "OFERTA ESPECIAL";
    const descripcion = oferta.descripcion || "Servicio especial";
    const precioOferta = parseInt(oferta.precio_oferta) || 0;
    const precioNormal = parseInt(oferta.precio_normal) || 0;
    
    console.log(`Datos procesados:`);
    console.log(`  Nombre: ${nombre}`);
    console.log(`  Descripción: ${descripcion}`);
    console.log(`  Precio oferta: ${precioOferta}`);
    console.log(`  Precio normal: ${precioNormal}`);
    
    // Actualizar contenido con datos específicos de la oferta
    const tituloElem = ofertaModal.querySelector('.oferta-titulo');
    const subtituloElem = ofertaModal.querySelector('.oferta-subtitulo');
    const descripcionElem = ofertaModal.querySelector('.oferta-descripcion');
    const precioOfertaElem = ofertaModal.querySelector('.precio-oferta-valor');
    const precioNormalElem = ofertaModal.querySelector('.precio-normal-valor');
    const ahorroElem = ofertaModal.querySelector('.ahorro-texto');
    
    if (tituloElem) {
        tituloElem.textContent = nombre;
        console.log(`✅ Título actualizado: ${nombre}`);
    }
    
    // Mostrar tipo de oferta en subtítulo
    if (subtituloElem) {
        if (oferta.tipo_duracion === "horas") {
            subtituloElem.textContent = `¡Oferta por ${oferta.duracion_horas} horas!`;
        } else if (oferta.inicio || oferta.fin) {
            subtituloElem.textContent = "¡Oferta por tiempo limitado!";
        } else {
            subtituloElem.textContent = "¡Oferta especial!";
        }
        console.log(`✅ Subtítulo actualizado: ${subtituloElem.textContent}`);
    }
    
    if (descripcionElem) {
        descripcionElem.textContent = descripcion;
        console.log(`✅ Descripción actualizada: ${descripcion}`);
    }
    
    if (precioOfertaElem) {
        precioOfertaElem.textContent = `$${precioOferta.toLocaleString('es-AR')}`;
        console.log(`✅ Precio oferta actualizado: $${precioOferta.toLocaleString('es-AR')}`);
    }
    
    if (precioNormalElem) {
        precioNormalElem.textContent = `$${precioNormal.toLocaleString('es-AR')}`;
        console.log(`✅ Precio normal actualizado: $${precioNormal.toLocaleString('es-AR')}`);
    }
    
    if (ahorroElem) {
        if (precioNormal > 0 && precioOferta > 0 && precioNormal > precioOferta) {
            const ahorro = precioNormal - precioOferta;
            const porcentaje = Math.round((ahorro / precioNormal) * 100);
            ahorroElem.textContent = `¡AHORRA $${ahorro.toLocaleString('es-AR')} (${porcentaje}%)!`;
            console.log(`✅ Ahorro calculado: $${ahorro} (${porcentaje}%)`);
        } else {
            ahorroElem.textContent = "¡OFERTA ESPECIAL!";
            console.log("⚠️ No se pudo calcular ahorro, mostrando texto genérico");
        }
    }
    
    // Mostrar el modal
    ofertaModal.classList.add('active');
    ofertaModal.style.display = 'flex';
    console.log("✅ Modal mostrado");
    
    // 🔴 CRÍTICO: Configurar botones CORRECTAMENTE
    const aceptarBtn = document.getElementById('aceptarOfertaBtn');
    const cerrarBtn = document.getElementById('cerrarOfertaBtn');
    
    // Remover eventos anteriores para evitar múltiples listeners
    if (aceptarBtn) {
        const nuevoAceptarBtn = aceptarBtn.cloneNode(true);
        aceptarBtn.parentNode.replaceChild(nuevoAceptarBtn, aceptarBtn);
        
        const nuevoBtn = document.getElementById('aceptarOfertaBtn');
        nuevoBtn.onclick = function() {
            console.log("🖱️ Botón ACEPTAR OFERTA clickeado");
            aceptarOfertaEspecifica(oferta);
        };
        console.log("✅ Botón aceptar configurado");
    }
    
    if (cerrarBtn) {
        const nuevoCerrarBtn = cerrarBtn.cloneNode(true);
        cerrarBtn.parentNode.replaceChild(nuevoCerrarBtn, cerrarBtn);
        
        const nuevoBtn = document.getElementById('cerrarOfertaBtn');
        nuevoBtn.onclick = function() {
            console.log("🖱️ Botón CERRAR clickeado");
            cerrarOferta();
        };
        console.log("✅ Botón cerrar configurado");
    }
}

// Agregar esta función al inicio del script
// REEMPLAZA completamente la función parseFirebaseDate:
function parseFirebaseDate(fechaFirebase) {
    if (!fechaFirebase) return null;
    
    try {
        console.log("🔍 Parseando fecha Firebase:", fechaFirebase);
        
        // Caso 1: Timestamp de Firebase (objeto con toDate)
        if (typeof fechaFirebase === 'object' && fechaFirebase !== null) {
            // Si tiene método toDate
            if (fechaFirebase.toDate && typeof fechaFirebase.toDate === 'function') {
                const fecha = fechaFirebase.toDate();
                console.log("✅ Parseado con toDate():", fecha);
                return fecha;
            }
            
            // Si tiene propiedades seconds/nanoseconds
            if (fechaFirebase.seconds !== undefined && fechaFirebase.nanoseconds !== undefined) {
                const fecha = new Date(fechaFirebase.seconds * 1000);
                console.log("✅ Parseado con seconds:", fecha);
                return fecha;
            }
            
            // Si es Date object
            if (fechaFirebase instanceof Date || (fechaFirebase.constructor && fechaFirebase.constructor.name === 'Date')) {
                console.log("✅ Ya es objeto Date:", fechaFirebase);
                return fechaFirebase;
            }
        }
        
        // Caso 2: String ISO (ej: "2024-01-01T10:00:00Z")
        if (typeof fechaFirebase === 'string') {
            // Intentar parsear como ISO
            const fechaISO = new Date(fechaFirebase);
            if (!isNaN(fechaISO.getTime())) {
                console.log("✅ Parseado como ISO string:", fechaISO);
                return fechaISO;
            }
            
            // Intentar formato español común
            if (fechaFirebase.includes('de')) {
                const meses = {
                    'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,
                    'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
                };
                
                const regex = /(\d{1,2}) de (\w+) de (\d{4})/i;
                const match = fechaFirebase.match(regex);
                
                if (match) {
                    const [, dia, mesStr, año] = match;
                    const mes = meses[mesStr.toLowerCase()];
                    
                    if (mes !== undefined) {
                        const fecha = new Date(año, mes, dia);
                        console.log("✅ Parseado formato español:", fecha);
                        return fecha;
                    }
                }
            }
        }
        
        console.warn("⚠️ No se pudo parsear fecha:", fechaFirebase);
        return null;
        
    } catch (error) {
        console.error("❌ Error parseando fecha:", error);
        return null;
    }
}

// Botón "Mes anterior" - VERSIÓN CORREGIDA
if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', function() {
        console.log("⬅️ CLICK EN MES ANTERIOR");
        console.log("Antes - Mes:", window.currentMonth, "(", monthNames[window.currentMonth], ")", "Año:", window.currentYear);
        
        // CORRECCIÓN: Manejo correcto del cambio de año
        window.currentMonth--;
        
        // Si el mes es menor a 0 (enero), ir a diciembre del año anterior
        if (window.currentMonth < 0) {
            window.currentMonth = 11; // Diciembre (índice 11)
            window.currentYear--;
        }
        
        console.log("Después - Mes:", window.currentMonth, "(", monthNames[window.currentMonth], ")", "Año:", window.currentYear);
        
        // Renderizar el nuevo calendario
        renderCalendar(window.currentMonth, window.currentYear);
    });
}

// Botón "Mes siguiente" - VERSIÓN CORREGIDA
if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', function() {
        console.log("➡️ CLICK EN MES SIGUIENTE");
        console.log("Antes - Mes:", window.currentMonth, "(", monthNames[window.currentMonth], ")", "Año:", window.currentYear);
        
        // CORRECCIÓN: Incrementar el mes
        window.currentMonth++;
        
        // Si el mes es mayor a 11 (diciembre), ir a enero del año siguiente
        if (window.currentMonth > 11) {
            window.currentMonth = 0; // Enero (índice 0)
            window.currentYear++;
        }
        
        console.log("Después - Mes:", window.currentMonth, "(", monthNames[window.currentMonth], ")", "Año:", window.currentYear);
        
        // Renderizar el nuevo calendario
        renderCalendar(window.currentMonth, window.currentYear);
    });
}

// Botón "Hoy" - VERSIÓN CORREGIDA
if (todayBtn) {
    todayBtn.addEventListener('click', function() {
        console.log("📅 Botón HOY presionado");
        const now = new Date();
        const newMonth = now.getMonth();  // Cambiado a newMonth
        const newYear = now.getFullYear();  // Cambiado a newYear
        
        console.log("Nuevo - Mes:", newMonth, "(", monthNames[newMonth], ")", "Año:", newYear);
        renderCalendar(newMonth, newYear);
        
        showNotification('Volviendo al mes actual', 'info');
    });
}

// FUNCIÓN DE DIAGNÓSTICO PARA VERIFICAR EL PROBLEMA
function debugCalendarBug() {
    console.log("=== DIAGNÓSTICO DEL BUG DEL CALENDARIO ===");
    
    // Verificar el array monthNames
    console.log("1. Array monthNames:", monthNames);
    console.log("   Longitud:", monthNames.length);
    
    // Verificar variables actuales
    console.log("2. Variables actuales:");
    console.log("   window.currentMonth:", window.currentMonth, "(", typeof window.currentMonth, ")");
    console.log("   window.currentYear:", window.currentYear, "(", typeof window.currentYear, ")");
    
    // Verificar el DOM actual
    const monthHeader = document.getElementById('currentMonth');
    console.log("3. DOM - currentMonth textContent:", monthHeader ? monthHeader.textContent : "NO ENCONTRADO");
    
    // Calcular qué debería mostrar
    console.log("4. Cálculo:");
    const now = new Date();
    console.log("   Fecha actual:", now.toString());
    console.log("   Mes actual:", now.getMonth(), "(", monthNames[now.getMonth()], ")");
    console.log("   Año actual:", now.getFullYear());
    
    // Mostrar secuencia de 12 meses
    console.log("5. Secuencia completa de meses:");
    for (let i = 0; i < 12; i++) {
        console.log(`   ${i}: ${monthNames[i]}`);
    }
    
    // Mostrar secuencia de navegación
    console.log("6. Navegación desde mes actual:");
    for (let i = 0; i < 6; i++) {
        let testMonth = window.currentMonth + i;
        let testYear = window.currentYear;
        
        // Ajustar si nos pasamos de diciembre
        if (testMonth > 11) {
            testMonth = testMonth % 12;
            testYear++;
        }
        
        console.log(`   +${i} meses: ${monthNames[testMonth]} ${testYear} (índice: ${testMonth})`);
    }
    
    console.log("=== FIN DEL DIAGNÓSTICO ===");
}

        function esFechaHoraPasada(fechaStr, horaStr) {
            try {
                const hoy = new Date();

                // Parsear la fecha seleccionada
                const [year, month, day] = fechaStr.split('-').map(Number);
                const [hour, minute] = horaStr.split(':').map(Number);

                // Crear objeto Date con la fecha y hora seleccionadas
                const fechaSeleccionada = new Date(year, month - 1, day, hour, minute);

                // Comparar con la fecha/hora actual
                return fechaSeleccionada < hoy;

            } catch (error) {
                console.error('Error verificando fecha:', error);
                return true; // Por seguridad, si hay error, no permitir
            }
        }


        // Función para formatear fecha como YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Función para formatear fecha para mostrar
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Agrega esta función y ejecútala en setupEventListeners
        function debugConfirmButton() {
            const confirmBtn = document.getElementById('confirmReservationBtn');

            if (!confirmBtn) {
                console.error('❌ Botón confirmReservationBtn no encontrado en el DOM');
                return;
            }

            console.log('🔍 Botón confirmReservationBtn encontrado');

            // Remover listeners anteriores (por si acaso)
            confirmBtn.removeEventListener('click', confirmReservation);

            // Agregar nuevo listener con logging
            confirmBtn.addEventListener('click', function (event) {
                console.log('🖱️ Botón de confirmación clickeado');
                console.log('📍 Evento:', event);
                console.log('📍 Botón:', this);

                // Verificar si hay un formulario
                const form = this.closest('form') || this.closest('.reservation-form');
                if (form) {
                    console.log('📋 Formulario encontrado:', form);
                }

                confirmReservation();
            });

            // También agregar listener para tecla Enter en los inputs
            const inputs = ['clientName', 'clientWhatsApp'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function (event) {
                        if (event.key === 'Enter') {
                            console.log('↵ Enter presionado en', inputId);
                            event.preventDefault();
                            confirmReservation();
                        }
                    });
                }
            });
        }

        function loadDefaultServices() {
            console.log('📦 Cargando servicios por defecto');

            servicePrices = {
                'Corte de Cabello': 2500,
                'Corte + Barba': 3200,
                'Arreglo de Barba': 1800,
                'Afeitado Clásico': 2200
            };
        }

        // Cargar agenda - VERSIÓN MEJORADA


        // Datos de demostración
        function loadDemoData() {
            console.log('Cargando datos demo');
            const exampleBookedSlots = {};
            const hoy = new Date();

            for (let i = 0; i < 10; i++) {
                const fecha = new Date();
                fecha.setDate(hoy.getDate() + i);
                const fechaStr = formatDate(fecha);

                if (Math.random() > 0.5) {
                    exampleBookedSlots[fechaStr] = [];
                    const horarios = ['09:00', '10:30', '14:00', '16:30'];
                    const cantidad = Math.floor(Math.random() * 3) + 1;

                    for (let j = 0; j < cantidad; j++) {
                        const horario = horarios[Math.floor(Math.random() * horarios.length)];
                        if (!exampleBookedSlots[fechaStr].includes(horario)) {
                            exampleBookedSlots[fechaStr].push(horario);
                        }
                    }
                }
            }

            window.bookedSlots = exampleBookedSlots;
        }

        // Dentro de setupEventListeners, asegura esto:
        const botonConfirmar = document.getElementById('confirmReservationBtn');
        if (botonConfirmar) {
            // Eliminar todos los listeners anteriores
            const nuevoBoton = botonConfirmar.cloneNode(true);
            botonConfirmar.parentNode.replaceChild(nuevoBoton, botonConfirmar);

            // Agregar listener al nuevo botón
            const botonFresco = document.getElementById('confirmReservationBtn');
            botonFresco.addEventListener('click', function (event) {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Verificar si existe la función
                if (typeof window.confirmReservation === 'function') {
                    window.confirmReservation();
                } else {
                    alert("Por favor, recarga la página.");
                }

                return false;
            });
        }

    // Inicializar bookedSlots si no existe
    window.bookedSlots = window.bookedSlots || {};
    window.blockedHours = window.blockedHours || {};

    // Inicializar calendario primero
inicializarCalendarioSimple();
    // Inicializar eventos
    setupEventListeners();
    
    // Inicializar Firebase después de un pequeño retraso
    setTimeout(() => {
        initializeFirebase();
    }, 500);

        // Mostrar página
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
            }

            if (pageId === 'reservationPage') {
                scheduleUpdateAvailableHours();
                updateReservationSummary();
            }
        }
        

            // Actualizar texto
            const dateObj = parseDate(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const selectedDateText = document.getElementById('selectedDateText');
            if (selectedDateText) {
                selectedDateText.textContent = `Turnos disponibles para el ${dateObj.toLocaleDateString('es-ES', options)}`;
            }

            scheduleUpdateAvailableHours();
            updateReservationSummary();
            debugTurnosReservados();


            // Scroll al formulario si ya hay hora seleccionada
            if (selectedTime) {
                scrollToReservationForm();
            }

            console.log("📅 Fecha seleccionada:", dateStr);
        
        // ========== CORRECCIÓN DE BUCLES EN FIREBASE LISTENERS ==========
// FUNCIÓN COMPLETA PARA ACTUALIZAR HORARIOS - VERSIÓN CORREGIDA
async function updateAvailableHours() {
    console.log("🔄 ACTUALIZANDO HORARIOS - " + new Date().toLocaleTimeString());
    
    const hoursList = document.getElementById('hoursList');
    if (!hoursList) {
        console.error("❌ Elemento hoursList no encontrado");
        return;
    }
    
    if (!window.selectedDate) {
        hoursList.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">Selecciona una fecha en el calendario</p>';
        return;
    }
    
    // Mostrar indicador de carga
    hoursList.innerHTML = '<div class="loading" style="margin: 20px auto;"></div>';
    
    try {
        console.log('📅 Buscando horarios para:', window.selectedDate);
        
        // Verificar si la fecha es pasada
        const fechaSeleccionada = parseDate(window.selectedDate);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        if (fechaSeleccionada < hoy) {
            hoursList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-calendar-times" style="color: #ff4444; font-size: 2rem;"></i>
                    <p style="color: #ff4444; font-weight: bold;">Fecha pasada</p>
                    <p style="color: #aaa; font-size: 0.9rem;">No se pueden reservar fechas anteriores a hoy</p>
                </div>
            `;
            return;
        }
        
        // Obtener datos de Firebase o usar demo
        let horariosOcupados = [];
        let horariosBloqueados = [];
        let horariosPersonalizados = null;
        
        if (db) {
            try {
                // Buscar turnos existentes para esta fecha
                const turnosSnapshot = await db.collection('turnos')
                    .where('fecha', '==', window.selectedDate)
                    .where('estado', 'in', ['pendiente', 'confirmado', 'asistio'])
                    .get();
                
                horariosOcupados = turnosSnapshot.docs.map(doc => doc.data().hora);
                console.log(`⏰ Horarios ocupados: ${horariosOcupados.length}`);
                
                // Buscar horarios bloqueados
                const configDoc = await db.collection('configuracion')
                    .doc('horariosBloqueados')
                    .get();
                
                if (configDoc.exists) {
                    const data = configDoc.data();
                    horariosBloqueados = data[window.selectedDate] || [];
                    console.log(`🚫 Horarios bloqueados: ${horariosBloqueados.length}`);
                }
                
                // 🔴 NUEVO: Buscar horarios personalizados de calendario_usuario
                const calendarioDoc = await db.collection('calendario_usuario')
                    .doc(window.selectedDate)
                    .get();
                
                if (calendarioDoc.exists) {
                    horariosPersonalizados = calendarioDoc.data();
                    console.log('🎯 Horarios personalizados encontrados:', horariosPersonalizados);
                } else {
                    console.log('📅 No hay horarios personalizados para esta fecha');
                }
                
            } catch (firebaseError) {
                console.warn("⚠️ Error Firebase, usando datos demo:", firebaseError.message);
                // Usar datos demo
                horariosOcupados = ['09:00', '14:00'];
                horariosBloqueados = [];
            }
        } else {
            // Modo demo
            console.log("📱 Usando datos demo para horarios");
            horariosOcupados = ['09:00', '14:00'];
            horariosBloqueados = [];
        }
        
        // Determinar horario laboral según configuración
        let horaInicio = 9;
        let horaFin = 19;
        let descansos = [];
        
        // 🔴 USAR HORARIOS PERSONALIZADOS SI EXISTEN
        if (horariosPersonalizados) {
            if (horariosPersonalizados.hora_inicio) {
                const [hora, minuto] = horariosPersonalizados.hora_inicio.split(':').map(Number);
                horaInicio = hora;
                console.log(`⏰ Hora inicio personalizada: ${horaInicio}:00`);
            }
            
            if (horariosPersonalizados.hora_fin) {
                const [hora, minuto] = horariosPersonalizados.hora_fin.split(':').map(Number);
                horaFin = hora;
                console.log(`⏰ Hora fin personalizada: ${horaFin}:00`);
            }
            
            if (horariosPersonalizados.descansos && Array.isArray(horariosPersonalizados.descansos)) {
                descansos = horariosPersonalizados.descansos;
                console.log(`⏸️ Descansos configurados: ${descansos.length}`);
            }
            
            // Verificar si el día está inactivo
            if (horariosPersonalizados.activo === false) {
                hoursList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-calendar-times" style="color: #d4af37; font-size: 2rem;"></i>
                        <p style="color: #d4af37; font-weight: bold;">Día no laboral</p>
                        <p style="color: #aaa; font-size: 0.9rem;">No hay atención en esta fecha</p>
                    </div>
                `;
                return;
            }
        }
        
        const esHoy = fechaSeleccionada.getDate() === hoy.getDate() && 
                     fechaSeleccionada.getMonth() === hoy.getMonth() && 
                     fechaSeleccionada.getFullYear() === hoy.getFullYear();
        
        const ahora = new Date();
        const horaActual = ahora.getHours();
        const minutoActual = ahora.getMinutes();
        
        let hoursHTML = '';
        let hayHorariosDisponibles = false;
        
        // 🔴 GENERAR HORARIOS SEGÚN CONFIGURACIÓN PERSONALIZADA
        for (let hour = horaInicio; hour <= horaFin; hour++) {
            // Solo horas en punto (00 minutos)
            const timeStr = `${hour.toString().padStart(2, '0')}:00`;
            
            // Verificar si es horario de descanso
            const esDescanso = descansos.some(descanso => {
                const [descansoHora] = descanso.split(':').map(Number);
                return descansoHora === hour;
            });
            
            if (esDescanso) {
                hoursHTML += `
                    <div class="hour-option disabled" 
                         title="Horario de descanso"
                         style="opacity: 0.4; background-color: #444;">
                        <s>${timeStr}</s><br>
                        <small style="color: #888;">Descanso</small>
                    </div>
                `;
                continue;
            }
            
            // Verificar si es horario pasado (solo hoy)
            let esHorarioPasado = false;
            if (esHoy) {
                if (hour < horaActual) {
                    esHorarioPasado = true;
                } else if (hour === horaActual && 0 < minutoActual) {
                    esHorarioPasado = true;
                }
            }
            
            const estaOcupado = horariosOcupados.includes(timeStr);
            const estaBloqueado = horariosBloqueados.includes(timeStr);
            
            let className = 'hour-option';
            let style = '';
            let title = '';
            let content = timeStr;
            let clickable = false;
            
            if (esHorarioPasado) {
                className += ' disabled';
                title = 'Horario ya pasó';
                style = 'opacity: 0.5; background-color: #222;';
                content = `<s>${timeStr}</s><br><small style="color: #aaa;">Pasado</small>`;
            }
            else if (estaBloqueado) {
                className += ' disabled';
                title = 'Horario bloqueado por administrador';
                style = 'opacity: 0.4; background-color: #444;';
                content = `<s>${timeStr}</s><br><small style="color: #ff4444;">Bloqueado</small>`;
            }
            else if (estaOcupado) {
                className += ' disabled';
                title = 'Horario reservado';
                style = 'opacity: 0.6; background-color: #333;';
                content = `<s>${timeStr}</s><br><small style="color: #ff9999;">Reservado</small>`;
            }
            else {
                hayHorariosDisponibles = true;
                clickable = true;
                className += ' available';
                style = 'cursor: pointer; border: 2px solid var(--primary); background-color: rgba(212, 175, 55, 0.1);';
                content += '<br><small style="color: #d4af37;">Disponible</small>';
            }
            
            hoursHTML += `
                <div class="${className}" 
                     data-time="${timeStr}" 
                     ${title ? `title="${title}"` : ''}
                     style="${style}"
                     ${clickable ? `onclick="selectTime('${timeStr}')"` : ''}>
                    ${content}
                </div>
            `;
        }
        
        // Actualizar el contenido
        if (hayHorariosDisponibles) {
            hoursList.innerHTML = hoursHTML;
        } else {
            hoursList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-calendar-times" style="color: #d4af37; font-size: 2rem;"></i>
                    <p style="color: #d4af37; font-weight: bold;">No hay horarios disponibles</p>
                    <p style="color: #aaa; font-size: 0.9rem;">
                        ${esHoy ? 'Los horarios de hoy ya pasaron' : 'Todos los horarios están ocupados o bloqueados'}
                    </p>
                </div>
            `;
        }
        
        console.log(`✅ Horarios actualizados. Disponibles: ${hayHorariosDisponibles ? 'Sí' : 'No'}`);
        console.log(`⏰ Rango horario usado: ${horaInicio}:00 a ${horaFin}:00`);
        
    } catch (error) {
        console.error('❌ Error en updateAvailableHours:', error);
        hoursList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #ff4444;">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error al cargar horarios</p>
                <p style="font-size: 0.9em; color: #aaa;">${error.message}</p>
                <button onclick="updateAvailableHours()" style="margin-top: 10px; padding: 5px 15px; background: var(--primary); color: var(--dark); border: none; border-radius: 4px; cursor: pointer;">
                    Reintentar
                </button>
            </div>
        `;
    }

       setTimeout(() => {
        verificarScrollHorarios();
    }, 100);
}

// 🔴 FUNCIÓN MEJORADA PARA CONFIGURAR LISTENERS DE FIREBASE
function setupFirebaseRealtimeListeners() {
    if (!db || firebaseListenersInitialized) {
        console.log("⏭️ Listeners ya inicializados o Firebase no disponible");
        return;
    }
    
    console.log("🔧 Configurando listeners de Firebase (UNA SOLA VEZ)");
    firebaseListenersInitialized = true;
    
    // 🔴 SINGLE LISTENER para cambios en turnos (combinado)
    let turnosListenerActive = false;
    
    const turnosListener = db.collection('turnos')
        .where('estado', 'in', ['pendiente', 'confirmado', 'asistio', 'cancelado'])
        .onSnapshot((snapshot) => {
            if (turnosListenerActive) {
                console.log("⏭️ Listener de turnos ya activo, ignorando llamada duplicada");
                return;
            }
            
            turnosListenerActive = true;
            console.log('🔄 Cambios detectados en turnos');
            
            // Cargar datos y actualizar UI
            loadBookedSlotsFromFirebase().then(() => {
                if (window.selectedDate) {
                    // Pequeño retraso para evitar múltiples actualizaciones rápidas
                    setTimeout(() => {
                        updateAvailableHours();
                        turnosListenerActive = false;
                    }, 300);
                } else {
                    turnosListenerActive = false;
                }
            }).catch(error => {
                console.error('Error en listener de turnos:', error);
                turnosListenerActive = false;
            });
        });

    // 🔴 SINGLE LISTENER para cambios en horarios bloqueados
    let horariosListenerActive = false;
    
    const horariosListener = db.collection('configuracion')
        .doc('horariosBloqueados')
        .onSnapshot((doc) => {
            if (horariosListenerActive) {
                console.log("⏭️ Listener de horarios ya activo, ignorando llamada duplicada");
                return;
            }
            
            horariosListenerActive = true;
            console.log('🔄 Cambios detectados en horarios bloqueados');
            
            if (doc.exists) {
                window.blockedHours = doc.data().horariosBloqueados || {};
                if (window.selectedDate) {
                    // Pequeño retraso para evitar múltiples actualizaciones rápidas
                    setTimeout(() => {
                        updateAvailableHours();
                        horariosListenerActive = false;
                    }, 300);
                } else {
                    horariosListenerActive = false;
                }
            } else {
                horariosListenerActive = false;
            }
        });

    // 🔴 LISTENER SIMPLIFICADO para sincronización (sin notificación automática)
    db.collection('configuracion').doc('ultima_sincronizacion')
        .onSnapshot((doc) => {
            if (doc.exists) {
                console.log('🔄 Cambios detectados en configuración de agenda');
                // No mostrar notificación automática para evitar spam
                
                // Solo recargar si hay fecha seleccionada
                if (window.selectedDate) {
                    // Debounce: esperar 500ms antes de actualizar
                    setTimeout(() => {
                        updateAvailableHours();
                    }, 500);
                }
            }
        });

    console.log("✅ Listeners de Firebase configurados correctamente");
}

// ========== SISTEMA DE ACTUALIZACIÓN AUTOMÁTICA ==========
async function initializeFirebase() {
    console.log("🚀 INICIALIZANDO FIREBASE CON RECONEXIÓN");
    
    if (window.firebaseConnectionTested) {
        console.log("⏭️ Conexión ya probada");
        return;
    }
    
    window.firebaseConnectionTested = true;
    
    // Verificar conexión primero
    const conectado = await checkFirebaseConnection();
    
    if (!conectado) {
        console.log("📱 Activando modo demostración...");
        
        // Datos de demostración completos
        loadDemoData();
        loadDefaultServices();
        
        // Ofertas demo
        window.ofertasDisponibles = [{
            nombre: "Corte + Afeitado Especial",
            descripcion: "Corte de cabello + Afeitado clásico",
            precio_oferta: 3900,
            precio_normal: 4700,
            activa: true,
            tipo_duracion: "horas",
            duracion_horas: 24,
            creado_en: new Date().toISOString()
        }];
        ofertaActiva = true;
        
        // Mostrar indicador de modo demo
        const syncIndicator = document.getElementById('syncIndicator');
        if (syncIndicator) {
            syncIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            syncIndicator.title = "Modo demostración - Sin conexión";
            syncIndicator.style.backgroundColor = "#ff4444";
            syncIndicator.onclick = function() {
                showNotification('Reconectando a la base de datos...', 'info');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            };
        }
        
        // Renderizar con datos demo
        if (window.selectedDate) {
            scheduleUpdateAvailableHours();
        }
        
        return;
    }
    
    try {
        // Conexión exitosa
        db = firebase.firestore();
        console.log("✅ Firebase listo");
        
        // Cargar datos iniciales
        await Promise.all([
            loadServiciosFromFirebase(),
            loadBookedSlotsFromFirebase(),
            verificarOfertasActivas()
        ]);
        
        // Configurar listeners en tiempo real
        setupRealtimeListeners();
        
        // Mostrar indicador de sincronización
        const syncIndicator = document.getElementById('syncIndicator');
        if (syncIndicator) {
            syncIndicator.style.display = 'flex';
            syncIndicator.innerHTML = '<i class="fas fa-sync-alt"></i>';
            syncIndicator.title = "Sincronización activa - Click para actualizar";
            syncIndicator.style.backgroundColor = "var(--primary)";
            
            syncIndicator.addEventListener('click', async function() {
                this.classList.add('syncing');
                showNotification('🔄 Actualizando datos...', 'info');
                
                try {
                    await Promise.all([
                        loadServiciosFromFirebase(),
                        loadBookedSlotsFromFirebase(),
                        verificarOfertasActivas()
                    ]);
                    
                    if (window.selectedDate) {
                        updateAvailableHours();
                    }
                    
                    showNotification('✅ Datos actualizados', 'success');
                } catch (error) {
                    showNotification('❌ Error al actualizar', 'error');
                } finally {
                    setTimeout(() => {
                        this.classList.remove('syncing');
                    }, 1000);
                }
            });
        }
        
        // Notificar al usuario
        setTimeout(() => {
            showNotification('✅ Conectado - Cambios se ven en tiempo real', 'success', 3000);
        }, 1000);
        
    } catch (error) {
        console.error("💥 Error crítico:", error);
        showNotification('❌ Error de conexión - Usando modo demostración', 'error');
        loadDemoData();
        loadDefaultServices();
    }
}

// Agrega esto AL PRINCIPIO de tu script, después de las variables globales
async function checkFirebaseConnection() {
    console.log("🔌 Probando conexión a Firebase...");
    
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Probar conexión simple
        const testRef = firebase.firestore().collection('servicios').limit(1);
        await testRef.get();
        console.log("✅ Firebase conectado correctamente");
        return true;
    } catch (error) {
        console.error("❌ Error de conexión Firebase:", error.message);
        console.error("Código de error:", error.code);
        
        // Mostrar notificación clara al usuario
        showNotification('⚠️ Modo demostración activado - Usando datos de ejemplo', 'info', 10000);
        return false;
    }
}

// ========== SISTEMA COMPLETO DE LISTENERS ==========
function setupRealtimeListeners() {
    if (!db) {
        console.log("❌ Firebase no disponible para listeners");
        return;
    }
    
    console.log("🔧 Configurando TODOS los listeners...");
    
    // 1. LISTENER PARA SERVICIOS (actualiza precios y servicios)
    db.collection('servicios')
        .orderBy('precio', 'asc')
        .onSnapshot((snapshot) => {
            console.log('🔄 Cambios detectados en SERVICIOS');
            loadServiciosFromFirebase().then(() => {
                console.log('✅ Servicios actualizados automáticamente');
                showNotification('📋 Servicios actualizados', 'info', 2000);
            });
        });
    
    // 2. LISTENER PARA TURNOS (actualiza horarios ocupados)
    db.collection('turnos')
        .where('estado', 'in', ['pendiente', 'confirmado', 'asistio'])
        .onSnapshot((snapshot) => {
            console.log('🔄 Cambios detectados en TURNOS');
            loadBookedSlotsFromFirebase().then(() => {
                console.log('✅ Turnos actualizados automáticamente');
                // Si hay fecha seleccionada, actualizar horarios
                if (window.selectedDate) {
                    scheduleUpdateAvailableHours();
                }
            });
        });
    
    // 3. LISTENER PARA HORARIOS BLOQUEADOS
    db.collection('configuracion')
        .doc('horariosBloqueados')
        .onSnapshot((doc) => {
            if (doc.exists) {
                console.log('🔄 Cambios detectados en HORARIOS BLOQUEADOS');
                window.blockedHours = doc.data().horariosBloqueados || {};
                if (window.selectedDate) {
                    scheduleUpdateAvailableHours();
                }
                showNotification('⏰ Horarios actualizados', 'info', 2000);
            }
        });
    
    // 4. LISTENER PARA CALENDARIO USUARIO (días no laborables)
    db.collection('calendario_usuario')
        .onSnapshot((snapshot) => {
            console.log('🔄 Cambios detectados en CALENDARIO');
            // Actualizar si la fecha seleccionada está afectada
            if (window.selectedDate) {
                scheduleUpdateAvailableHours();
                showNotification('📅 Disponibilidad actualizada', 'info', 2000);
            }
        });
    
    // 5. LISTENER PARA OFERTAS
    db.collection('ofertas')
        .onSnapshot((snapshot) => {
            console.log('🔄 Cambios detectados en OFERTAS');
            verificarOfertasActivas().then((hayOfertas) => {
                if (hayOfertas) {
                    console.log('✅ Ofertas actualizadas automáticamente');
                    
                    // Si ya se seleccionó fecha y hora, verificar si hay ofertas nuevas
                    if (window.selectedDate && window.selectedTime && window.selectedService && !ofertaSeleccionada) {
                        setTimeout(() => {
                            verificarYMostrarOferta();
                        }, 500);
                    }
                    
                    showNotification('🎁 Ofertas actualizadas', 'info', 2000);
                } else {
                    console.log('ℹ️ No hay ofertas activas');
                }
            });
        });
    
    // 6. LISTENER PARA SINCRONIZACIÓN GENERAL
    db.collection('configuracion')
        .doc('ultima_sincronizacion')
        .onSnapshot((doc) => {
            if (doc.exists) {
                console.log('🔄 Sincronización detectada');
                // Pequeño delay para evitar múltiples actualizaciones
                setTimeout(() => {
                    // Actualizar UI según lo que esté visible
                    if (document.getElementById('reservationPage').classList.contains('active')) {
                        if (window.selectedDate) {
                            scheduleUpdateAvailableHours();
                        }
                        updateReservationSummary();
                    }
                }, 300);
            }
        });
    
    console.log("✅ TODOS los listeners configurados correctamente");
}

// 🔴 FUNCIÓN CORREGIDA - YA NO DECLARA loadingBookedSlots AQUÍ
async function loadBookedSlotsFromFirebase() {
    // Debounce para evitar múltiples cargas simultáneas
    const now = Date.now();
    if (loadingBookedSlots || (now - lastBookedSlotsLoad < 2000)) {
        console.log("⏭️ Debounce activado para loadBookedSlotsFromFirebase");
        return;
    }
    
    loadingBookedSlots = true;
    lastBookedSlotsLoad = now;
    
    if (!db) {
        loadDemoData();
        loadingBookedSlots = false;
        return;
    }

    try {
        console.log('📅 Cargando turnos actualizados...');
        
        const turnosSnapshot = await db.collection('turnos')
            .where('estado', 'in', ['pendiente', 'confirmado', 'asistio'])
            .get();

        window.bookedSlots = {};
        window.blockedHours = window.blockedHours || {};

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        // Procesar turnos reservados
        let turnosCount = 0;
        turnosSnapshot.forEach(doc => {
            const turno = doc.data();
            if (turno.fecha && turno.hora && turno.estado) {
                const fechaTurno = parseDate(turno.fecha);
                // Solo fechas futuras
                if (fechaTurno < hoy) return;
                
                if (!window.bookedSlots[turno.fecha]) {
                    window.bookedSlots[turno.fecha] = [];
                }
                if (!window.bookedSlots[turno.fecha].includes(turno.hora)) {
                    window.bookedSlots[turno.fecha].push(turno.hora);
                    turnosCount++;
                }
            }
        });

        console.log(`✅ ${turnosCount} turnos cargados para ${Object.keys(window.bookedSlots).length} fechas`);

        // Cargar horarios bloqueados
        try {
            const configSnapshot = await db.collection('configuracion')
                .doc('horariosBloqueados')
                .get();

            if (configSnapshot.exists) {
                window.blockedHours = configSnapshot.data().horariosBloqueados || {};
                console.log('✅ Horarios bloqueados actualizados');
            }
        } catch (configError) {
            console.log('⚠️ No se pudieron cargar horarios bloqueados:', configError.message);
        }

    } catch (error) {
        console.error('❌ Error cargando datos:', error);
    } finally {
        loadingBookedSlots = false;
    }
}

// ========== CORRECCIÓN ADICIONAL: EVITAR MULTIPLES LLAMADAS A updateAvailableHours ==========
// Función debounce para updateAvailableHours
function scheduleUpdateAvailableHours() {
    if (updateHoursTimeout) {
        clearTimeout(updateHoursTimeout);
    }
    
    updateHoursTimeout = setTimeout(() => {
        updateAvailableHours();
        updateHoursTimeout = null;
    }, 300);
}

// Función para detectar cambios y notificar
function setupChangeNotifications() {
    if (!db) return;
    
    // Listener para cambios en turnos
    db.collection('turnos')
        .where('estado', 'in', ['pendiente', 'confirmado'])
        .onSnapshot((snapshot) => {
            if (ultimaSincronizacion) {
                console.log('🔄 Cambios detectados en turnos');
                mostrarNotificacionCambio();
            }
            ultimaSincronizacion = new Date();
        });
    
    // Listener para cambios en horarios bloqueados
    db.collection('configuracion')
        .doc('horariosBloqueados')
        .onSnapshot((doc) => {
            if (ultimaSincronizacion && doc.exists) {
                console.log('🔄 Cambios detectados en horarios');
                mostrarNotificacionCambio();
            }
        });
    
    // Listener para cambios en servicios
    db.collection('servicios').onSnapshot((snapshot) => {
        if (ultimaSincronizacion) {
            console.log('🔄 Cambios detectados en servicios');
            mostrarNotificacionCambio();
        }
    });
    
    // Listener para cambios en ofertas
    db.collection('ofertas').onSnapshot((snapshot) => {
        if (ultimaSincronizacion) {
            console.log('🔄 Cambios detectados en ofertas');
            mostrarNotificacionCambio();
        }
    });
}

// Función para mostrar notificación de cambios
function mostrarNotificacionCambio() {
    if (notificacionCambiosPendiente) return;
    
    notificacionCambiosPendiente = true;
    
    // Crear notificación persistente
    const notificacion = document.createElement('div');
    notificacion.id = 'changeNotification';
    notificacion.innerHTML = `
        <div style="position: fixed; top: 80px; right: 20px; background: var(--primary); 
             color: var(--dark); padding: 15px 20px; border-radius: 8px; z-index: 9999;
             box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
             animation: slideIn 0.3s ease;">
            <i class="fas fa-sync-alt"></i>
            <div>
                <strong>Cambios detectados</strong>
                <div style="font-size: 0.9em; opacity: 0.9;">Nuevos horarios disponibles</div>
            </div>
            <button onclick="recargarDatos()" style="margin-left: 15px; background: var(--dark); 
                    color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">
                Actualizar
            </button>
            <button onclick="cerrarNotificacion()" style="background: transparent; border: none; 
                    color: var(--dark); font-size: 1.2em; cursor: pointer; margin-left: 10px;">
                ×
            </button>
        </div>
    `;
    
    document.body.appendChild(notificacion);
    
    // Auto-ocultar después de 30 segundos
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.parentNode.removeChild(notificacion);
                    notificacionCambiosPendiente = false;
                }
            }, 300);
        }
    }, 30000);
}

// Función para recargar datos
function recargarDatos() {
    showNotification('🔄 Actualizando datos...', 'info');
    
    Promise.all([
        loadServiciosFromFirebase(),
        loadBookedSlotsFromFirebase(),
        verificarOfertasActivas()
    ]).then(() => {
        if (window.selectedDate) {
            updateAvailableHours();
        }
        showNotification('✅ Datos actualizados', 'success');
        cerrarNotificacion();
    }).catch(error => {
        showNotification('❌ Error al actualizar', 'error');
    });
}

function cerrarNotificacion() {
    const notificacion = document.getElementById('changeNotification');
    if (notificacion) {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
                notificacionCambiosPendiente = false;
            }
        }, 300);
    }
}

// Agregar animaciones CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .sync-indicator.syncing {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
`;
document.head.appendChild(style);

        // Scroll al formulario
        function scrollToReservationForm() {
            setTimeout(() => {
                const reservationSection = document.getElementById('reservation');
                if (reservationSection) {
                    reservationSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        // 🔴 DECLARAR PRIMERO la constante
        const horasValidasBarberia = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        const startHour = 0;  // Admin configura desde 2:00
        const endHour = 23;   // Admin configura hasta 23:00

        // Función para validar número de WhatsApp
        function validarWhatsApp(numero) {
            // Eliminar espacios, guiones y otros caracteres
            const numeroLimpio = numero.replace(/\s+/g, '').replace(/-/g, '');

            // Verificar que solo contenga números
            if (!/^\d+$/.test(numeroLimpio)) {
                return { valido: false, mensaje: "El número debe contener solo dígitos" };
            }

            // Para Argentina: verificar longitud (ej: 1155739203 = 10 dígitos)
            if (numeroLimpio.length < 10) {
                return { valido: false, mensaje: "Número muy corto. Mínimo 10 dígitos" };
            }

            if (numeroLimpio.length > 15) {
                return { valido: false, mensaje: "Número muy largo. Máximo 15 dígitos" };
            }

            // Validación específica para Argentina (opcional)
            if (numeroLimpio.startsWith('549') && numeroLimpio.length !== 12) {
                return { valido: false, mensaje: "Número con código de país debe tener 12 dígitos (549 + 9 dígitos)" };
            }

            // Si empieza con 11 (ejemplo para Buenos Aires) debe tener 10 dígitos
            if (numeroLimpio.startsWith('11') && numeroLimpio.length !== 10) {
                return { valido: false, mensaje: "Números de Buenos Aires deben tener 10 dígitos" };
            }

            return {
                valido: true,
                numeroFormateado: formatearWhatsApp(numeroLimpio),
                numeroLimpio: numeroLimpio
            };
        }

        // Función para formatear el número para mostrar
        function formatearWhatsApp(numero) {
            const num = numero.replace(/\D/g, '');

            if (num.startsWith('549')) {
                // Formato internacional: +54 9 11 1234-5678
                const codigoPais = num.substring(0, 3);
                const codigoArea = num.substring(3, 5);
                const primeraParte = num.substring(5, 9);
                const segundaParte = num.substring(9, 13);
                return `+${codigoPais} ${codigoArea} ${primeraParte}-${segundaParte}`;
            } else if (num.length === 10) {
                // Formato local: 11 1234-5678
                const codigoArea = num.substring(0, 2);
                const primeraParte = num.substring(2, 6);
                const segundaParte = num.substring(6, 10);
                return `${codigoArea} ${primeraParte}-${segundaParte}`;
            }

            return num;
        }

        // Función para formatear el número para WhatsApp URL
        function formatearWhatsAppParaURL(numero) {
            const num = numero.replace(/\D/g, '');

            // Si no empieza con 549, agregar código de Argentina
            if (!num.startsWith('549')) {
                // Asumir que es un número local (agregar 549)
                return '549' + num;
            }

            return num;
        }

        // Actualizar resumen
        function updateReservationSummary() {
            const summaryDate = document.getElementById('summaryDate');
            const summaryTime = document.getElementById('summaryTime');
            const summaryService = document.getElementById('summaryService');
            const summaryPrice = document.getElementById('summaryPrice');

            if (summaryDate) {
                summaryDate.textContent = window.selectedDate
                    ? formatDateForDisplay(parseDate(window.selectedDate))
                    : 'No seleccionada';
            }

            if (summaryTime) {
                summaryTime.textContent = window.selectedTime || 'No seleccionada';
            }

            if (summaryService) {
                summaryService.textContent = window.selectedService || 'No seleccionado';
            }

            let price = 0;
            if (window.selectedService && servicePrices[window.selectedService]) {
                price = servicePrices[window.selectedService];
            }

            if (summaryPrice) {
                summaryPrice.textContent = `$${price.toLocaleString('es-AR')}`;
            }

            console.log("📊 Resumen actualizado:", {
                fecha: window.selectedDate,
                hora: window.selectedTime,
                servicio: window.selectedService,
                precio: price
            });
        }

// Función para actualizar días específicos en el calendario
function actualizarDiasCalendario(fechasCambiadas) {
    if (!calendarioInicializado) return;
    
    const calendarDates = document.getElementById('calendarDates');
    if (!calendarDates) return;
    
    // Si no hay fechas específicas, actualizar todo el calendario
    if (!fechasCambiadas || fechasCambiadas.length === 0) {
        renderizarDiasCalendario();
        return;
    }
    
    // Actualizar solo los días afectados
    const dateElements = calendarDates.querySelectorAll('.calendar-date');
    dateElements.forEach(dayElement => {
        const dateStr = dayElement.dataset.date;
        if (dateStr && fechasCambiadas.includes(dateStr)) {
            // Verificar si el día está completamente reservado
            const fullyBooked = checkIfDateFullyBooked(dateStr);
            
            // Actualizar clase según disponibilidad
            if (fullyBooked) {
                dayElement.style.opacity = '0.6';
                dayElement.title = 'Día completamente reservado';
            } else {
                dayElement.style.opacity = '1';
                dayElement.title = '';
            }
        }
    });
    
    console.log(`✅ Calendario actualizado para ${fechasCambiadas.length} fechas`);
}

// Variable para controlar notificaciones frecuentes
let lastNotificationTime = 0;
const NOTIFICATION_COOLDOWN = 5000; // 5 segundos entre notificaciones

function showNotification(message, type = "info", duration = 5000) {
    // Cooldown para no molestar con muchas notificaciones
    const now = Date.now();
    if (now - lastNotificationTime < NOTIFICATION_COOLDOWN && type === "info") {
        console.log(`⏭️ Notificación omitida por cooldown: ${message}`);
        return;
    }
    
    lastNotificationTime = now;
    
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.className = 'notification ' + type;
    notification.style.display = 'block';
    
    // Ocultar después del tiempo especificado
    setTimeout(() => {
        notification.style.display = 'none';
    }, duration);
}

        async function notificarActualizacionAgenda() {
            try {
                // Crear un marcador en configuracion para que user.html sepa que debe recargar
                await db.collection('configuracion').doc('ultima_sincronizacion').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    mensaje: 'Agenda actualizada',
                    version: Date.now()
                });
                console.log('✅ Notificación de actualización enviada');
            } catch (error) {
                console.error('Error al notificar:', error);
                // No mostrar error al usuario, es solo una notificación
            }
        }

        // Nueva función para cargar configuración de agenda
        async function cargarConfiguracionAgenda(fecha) {
            try {
                console.log('🔍 Buscando configuración para:', fecha);

                // 1. Primero intentar desde calendario_usuario
                const configDoc = await db.collection('calendario_usuario').doc(fecha).get();

                if (configDoc.exists) {
                    const config = configDoc.data();
                    console.log('✅ Configuración encontrada en calendario_usuario');
                    return config;
                }

                // 2. Si no existe, verificar si es un día de la semana
                const fechaObj = parseDate(fecha);
                const diaSemana = fechaObj.getDay(); // 0=Domingo, 1=Lunes...

                // Horarios por defecto según día de la semana
                const configPorDefecto = {
                    activo: true,
                    hora_inicio: '09:00',
                    hora_fin: '19:00',
                    descansos: diaSemana === 0 || diaSemana === 6 ? [] : ['12:00', '13:00'],
                    duracion_cita: 60
                };

                console.log('⚠️ Usando configuración por defecto para', fechaObj.toLocaleDateString('es-ES', { weekday: 'long' }));
                return configPorDefecto;

            } catch (error) {
                console.error('❌ Error al cargar configuración:', error);
                // Configuración por defecto de emergencia
                return {
                    activo: false,
                    hora_inicio: '09:00',
                    hora_fin: '19:00',
                    descansos: [],
                    duracion_cita: 60
                };
            }
        }

        // Función principal de confirmación de reserva - VERSIÓN CORREGIDA
        async function confirmReservation() {
            console.log("🛑 confirmReservation INICIANDO");

              // Si hay oferta seleccionada, verificar que el servicio sea el correcto
    if (ofertaSeleccionada && window.selectedService !== "Corte + Afeitado Especial") {
        ofertaSeleccionada = false;
    }

            // 🔴 BLOQUEAR MÚLTIPLES EJECUCIONES
            if (reservaEnProgreso) {
                console.log("⏸️ Ya hay una reserva en progreso, ignorando clic");
                return;
            }

            reservaEnProgreso = true;

            // Obtener valores
            const nombre = document.getElementById('clientName')?.value.trim() || "";
            const whatsapp = document.getElementById('clientWhatsApp')?.value.trim() || "";
            const servicio = window.selectedService;
            const fecha = window.selectedDate;
            const hora = window.selectedTime;

            console.log('📝 Datos para reserva:', { nombre, whatsapp, servicio, fecha, hora });

            // 🔴 VALIDAR WHATSAPP ANTES DE CONTINUAR
            const validacionWhatsApp = validarWhatsApp(whatsapp);
            if (!validacionWhatsApp.valido) {
                showNotification(`❌ WHATSAPP INVÁLIDO: ${validacionWhatsApp.mensaje}`, "error");
                reservaEnProgreso = false;
                return;
            }

            // Usar el número validado y formateado
            const whatsappValidado = validacionWhatsApp.numeroFormateado;
            const whatsappParaURL = formatearWhatsAppParaURL(validacionWhatsApp.numeroLimpio);

            // Validaciones
            if (!nombre || !whatsapp || !servicio || !fecha || !hora) {
                const faltantes = [];
                if (!nombre) faltantes.push("Nombre");
                if (!whatsapp) faltantes.push("WhatsApp");
                if (!servicio) faltantes.push("Servicio");
                if (!fecha) faltantes.push("Fecha");
                if (!hora) faltantes.push("Hora");

                showNotification("❌ FALTAN DATOS: " + faltantes.join(", "), "error");
                reservaEnProgreso = false; // Liberar
                return;
            }

            // Obtener precio
            const precio = window.servicePrices[servicio];
            if (!precio) {
                showNotification("❌ Error: servicio no válido", "error");
                reservaEnProgreso = false; // Liberar
                return;
            }

            // Cambiar estado del botón
            const confirmBtn = document.getElementById('confirmReservationBtn');
            const originalBtnText = confirmBtn?.innerHTML || '';

            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="loading"></span> Procesando...';
            }

            try {
                // Formatear fecha para mostrar
                let fechaBonita = fecha;
                try {
                    const [year, month, day] = fecha.split('-');
                    const dateObj = new Date(year, month - 1, day);
                    fechaBonita = dateObj.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    console.error("Error formateando fecha:", e);
                    fechaBonita = fecha;
                }

                // ACTUALIZAR CONTENIDO DEL MODAL
                console.log("🎯 Actualizando contenido del modal...");

                // Actualizar cada campo del modal
                const actualizarCampo = (id, valor) => {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        elemento.textContent = valor;
                        return true;
                    }
                    return false;
                };

                actualizarCampo('newModalClientName', nombre);
                actualizarCampo('newModalWhatsApp', whatsappValidado);
                actualizarCampo('newModalDate', fechaBonita);
                actualizarCampo('newModalTime', hora);
                actualizarCampo('newModalService', servicio);
                actualizarCampo('newModalPrice', `$${precio.toLocaleString('es-AR')}`);

                // Configurar botón de WhatsApp
                const mensajeWhatsapp = `Hola Alexis, soy ${nombre}. Quiero confirmar mi reserva en A.S. Studio:%0A%0A📅 Fecha: ${fechaBonita}%0A⏰ Hora: ${hora}%0A✂️ Servicio: ${servicio}%0A💰 Total: $${precio.toLocaleString('es-AR')}%0A%0AMi WhatsApp: ${whatsapp}%0A%0A¿Está disponible este horario?`;

                const whatsappBtn = document.getElementById('newWhatsappConfirmBtn');
                if (whatsappBtn) {
                    // Remover eventos anteriores
                    const nuevoBtn = whatsappBtn.cloneNode(true);
                    whatsappBtn.parentNode.replaceChild(nuevoBtn, whatsappBtn);
                    const newWhatsappBtn = document.getElementById('newWhatsappConfirmBtn');

                    newWhatsappBtn.onclick = function () {
                        window.open(`https://wa.me/54911155739203?text=${mensajeWhatsapp}`, '_blank');
                        setTimeout(() => {
                            closeNewModal();
                        }, 1000);
                    };
                }

                // Configurar botón de cerrar
                const closeBtn = document.getElementById('newCloseModalBtn');
                if (closeBtn) {
                    closeBtn.onclick = closeNewModal;
                }

                // MOSTRAR EL MODAL
                const newModal = document.getElementById('newConfirmationModal');
                if (newModal) {
                    newModal.style.display = 'flex';
                    setTimeout(() => {
                        newModal.classList.add('active');

                        // Guardar en Firebase (en segundo plano)
                        setTimeout(async () => {
                            try {
                                console.log("💾 Guardando en Firebase...");
                                const result = await saveReservationToFirebase(nombre, whatsapp);
                                console.log('✅ Resultado Firebase:', result);

                                if (result.success) {
                                    // Actualizar slots localmente SOLO UNA VEZ
                                    if (!window.bookedSlots[fecha]) {
                                        window.bookedSlots[fecha] = [];
                                    }
                                    window.bookedSlots[fecha].push(hora);
                                    scheduleUpdateAvailableHours();
                                    showNotification("✅ Reserva guardada correctamente", "success");
                                } else {
                                    showNotification(`❌ ${result.message || 'Error al guardar'}`, 'error');
                                }
                            } catch (error) {
                                console.error('⚠️ Error guardando en Firebase:', error);
                                showNotification("⚠️ Error al guardar la reserva", "error");
                            }
                        }, 500);
                    }, 50);
                }

            } catch (error) {
                console.error('❌ Error:', error);
                showNotification('❌ Error al procesar la reserva', 'error');
            } finally {
                // Restaurar botón después de 3 segundos y liberar
                setTimeout(() => {
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = originalBtnText;
                    }
                    reservaEnProgreso = false; // 🔴 IMPORTANTE: Liberar para nuevas reservas
                    console.log("🟢 Reserva completada, sistema liberado");
                }, 3000);
            }
        }

        // Función para cerrar el modal
        function closeNewModal() {
            console.log("🔴 Cerrando modal...");
            const modal = document.getElementById('newConfirmationModal');
            if (modal) {
                modal.classList.remove('active');

                // Esperar a que termine la animación antes de ocultar
                setTimeout(() => {
                    modal.style.display = 'none';
                    resetForm();
                    console.log("✅ Modal cerrado y formulario limpiado");
                }, 300);
            }
        }

        // Función para mostrar notificaciones
        function showNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            if (!notification) return;

            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';

            // Ocultar después de 5 segundos
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Configurar eventos del modal
        function setupModalEvents() {
            console.log("🔧 Configurando eventos del modal...");

            // Botón cerrar
            const closeBtn = document.getElementById('newCloseModalBtn');
            if (closeBtn) {
                closeBtn.onclick = closeNewModal;
                console.log("✅ Botón cerrar configurado");
            }

            // Cerrar al hacer clic fuera
            const modal = document.getElementById('newConfirmationModal');
            if (modal) {
                modal.onclick = function (e) {
                    if (e.target === this) {
                        closeNewModal();
                    }
                };
                console.log("✅ Clic fuera configurado");
            }

            // Cerrar con tecla ESC
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('newConfirmationModal');
                    if (modal && modal.classList.contains('active')) {
                        closeNewModal();
                    }
                }
            });
            console.log("✅ Tecla ESC configurada");

            // Función para cerrar el modal
            function closeNewModal() {
                console.log("🔴 Cerrando modal...");
                const modal = document.getElementById('newConfirmationModal');
                if (modal) {
                    modal.classList.remove('active');

                    // Esperar a que termine la animación antes de ocultar
                    setTimeout(() => {
                        modal.style.display = 'none';
                        resetForm();
                        console.log("✅ Modal cerrado y formulario limpiado");
                    }, 300);
                }
            }

            // Función para resetear el formulario
            function resetForm() {
   console.log("🧹 Limpiando formulario completo");

                // Limpiar campos del formulario
                document.getElementById('clientName').value = '';
                document.getElementById('clientWhatsApp').value = '';
                document.getElementById('serviceSelect').value = '';

                // Limpiar selecciones
                document.querySelectorAll('.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                // Resetear variables globales
                window.selectedDate = null;
                window.selectedTime = null;
                window.selectedService = null;

                // Actualizar UI
                updateReservationSummary();
                scheduleUpdateAvailableHours();

                 // Limpiar estado de ofertas
    limpiarTodoEstadoOfertas();
    

                // Volver al calendario
                const selectedDateText = document.getElementById('selectedDateText');
                if (selectedDateText) {
                    selectedDateText.textContent = 'Selecciona una fecha en el calendario';
                }

                console.log("✅ Formulario reseteado");
            }
        

            // Función para mostrar notificaciones (si no la tienes)
            function showNotification(message, type = "info") {
                const notification = document.getElementById('notification');
                if (!notification) return;

                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.style.display = 'block';

                // Ocultar después de 5 segundos
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }

            // FUNCIÓN NUEVA que muestra el modal INMEDIATAMENTE
            function mostrarModalInmediato(nombre, whatsapp, fecha, hora, servicio, precio) {
                console.log("🎯 Mostrando modal inmediato");

                // Formatear fecha
                let fechaBonita = fecha;
                try {
                    const [year, month, day] = fecha.split('-');
                    const dateObj = new Date(year, month - 1, day);
                    fechaBonita = dateObj.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    console.error("Error formateando fecha:", e);
                }

                // 1. ACTUALIZAR CONTENIDO DEL MODAL
                const elementos = {
                    'modalClientName': nombre,
                    'modalWhatsApp': whatsapp,
                    'modalDate': fechaBonita,
                    'modalTime': hora,
                    'modalService': servicio,
                    'modalPrice': `$${precio.toLocaleString('es-AR')}`
                };

                for (const [id, valor] of Object.entries(elementos)) {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        elemento.textContent = valor;
                        console.log(`✅ ${id} actualizado:`, valor);
                    } else {
                        console.error(`❌ Elemento ${id} no encontrado`);
                    }
                }

                // 2. CONFIGURAR WHATSAPP
                const mensajeWhatsapp = `Hola Alexis, soy ${nombre}. Quiero confirmar mi reserva en A.S. Studio:%0A%0A📅 Fecha: ${fechaBonita}%0A⏰ Hora: ${hora}%0A✂️ Servicio: ${servicio}%0A💰 Total: $${precio.toLocaleString('es-AR')}%0A%0AMi WhatsApp: ${whatsapp}%0A%0A¿Está disponible este horario?`;

                const whatsappLink = document.getElementById('whatsappLink');
                if (whatsappLink) {
                    whatsappLink.href = `https://wa.me/54911155739203?text=${mensajeWhatsapp}`;
                    whatsappLink.dataset.message = mensajeWhatsapp;
                    console.log("✅ WhatsApp configurado");
                }

                // 3. CONFIGURAR BOTÓN COPIAR
                const copyBtn = document.getElementById('copyMessageBtn');
                if (copyBtn) {
                    copyBtn.onclick = function () {
                        const texto = `Reserva A.S. Studio\nCliente: ${nombre}\nWhatsApp: ${whatsapp}\nFecha: ${fechaBonita}\nHora: ${hora}\nServicio: ${servicio}\nTotal: $${precio.toLocaleString('es-AR')}`;

                        navigator.clipboard.writeText(texto).then(() => {
                            alert('✅ Información copiada al portapapeles');
                        }).catch(() => {
                            // Fallback para navegadores antiguos
                            const textarea = document.createElement('textarea');
                            textarea.value = texto;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            alert('✅ Información copiada');
                        });
                    };
                }
            }

            // Función simple para cerrar el modal
            function closeNewModal() {
                console.log("🔴 Cerrando modal...");
                const modal = document.getElementById('newConfirmationModal');
                if (modal) {
                    modal.classList.remove('active');
                    console.log("✅ Modal cerrado");

                    // Limpiar formulario
                    resetForm();
                }
            }

            // Configurar eventos del modal - versión simplificada
            function setupModalEvents() {
                console.log("🔧 Configurando eventos del modal...");

                // Botón cerrar
                const closeBtn = document.getElementById('newCloseModalBtn');
                if (closeBtn) {
                    closeBtn.onclick = closeNewModal;
                    console.log("✅ Botón cerrar configurado");
                }

                // Cerrar al hacer clic fuera
                const modal = document.getElementById('newConfirmationModal');
                if (modal) {
                    modal.onclick = function (e) {
                        if (e.target === this) {
                            closeNewModal();
                        }
                    };
                    console.log("✅ Clic fuera configurado");
                }

                // Cerrar con tecla ESC
                document.onkeydown = function (e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('newConfirmationModal');
                        if (modal && modal.classList.contains('active')) {
                            closeNewModal();
                        }
                    }
                };
                console.log("✅ Tecla ESC configurada");
            }
        }
        

// Función selectDate (si no existe)
function selectDate(dateStr) {
    console.log("📅 Fecha seleccionada:", dateStr);
    window.selectedDate = dateStr;
    
    // Resetear oferta si cambia la fecha
    if (ofertaSeleccionada) {
        ofertaSeleccionada = false;
        
        // Quitar la opción de oferta del selector
        const serviceSelect = document.getElementById('serviceSelect');
        if (serviceSelect) {
            const ofertaOption = serviceSelect.querySelector('option[value="Corte + Afeitado Especial"]');
            if (ofertaOption) {
                ofertaOption.remove();
            }
        }
    }

    function limpiarTodoEstadoOfertas() {
    console.log("🧹 Limpiando todo el estado de ofertas");
    ofertaMostradaParaFechaHora = {};
    ofertaRechazadaParaFechaHora = {};
    ofertaSeleccionada = false;
}
    
    // Marcar como seleccionada
    document.querySelectorAll('.calendar-date').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.date === dateStr) {
            el.classList.add('selected');
        }
    });
    
    // Actualizar texto
    const dateObj = parseDate(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const selectedDateText = document.getElementById('selectedDateText');
    if (selectedDateText) {
        selectedDateText.textContent = `Turnos disponibles para el ${dateObj.toLocaleDateString('es-ES', options)}`;
    }
    
    // Actualizar horarios
    if (typeof scheduleUpdateAvailableHours === 'function') {
        scheduleUpdateAvailableHours();
    }
}

// Función para hacer scroll a la sección de reserva
function scrollToReservationForm() {
    setTimeout(() => {
        const reservationSection = document.getElementById('reservation');
        if (reservationSection) {
            reservationSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            // Opcional: Agregar un pequeño efecto visual
            reservationSection.style.transition = 'box-shadow 0.3s ease';
            reservationSection.style.boxShadow = '0 0 20px rgba(212, 175, 55, 0.5)';
            
            setTimeout(() => {
                reservationSection.style.boxShadow = '';
            }, 1000);
        }
    }, 300); // Pequeño delay para mejor UX
}

// ========== FUNCIONES PARA LEER MÁS/MENOS ==========
document.addEventListener('DOMContentLoaded', function() {
    // Verificar qué descripciones son largas y necesitan botón
    setTimeout(() => {
        checkDescriptionsLength();
    }, 100);
});

function checkDescriptionsLength() {
    const descriptions = document.querySelectorAll('.service-description');
    
    descriptions.forEach(desc => {
        const element = desc;
        const lineHeight = parseInt(window.getComputedStyle(element).lineHeight);
        const maxHeight = lineHeight * 3; // 3 líneas
        
        // Verificar si el contenido es más alto que 3 líneas
        if (element.scrollHeight > maxHeight) {
            element.classList.remove('short');
            element.classList.add('long');
            
            // Mostrar el botón "Leer más"
            const button = element.nextElementSibling;
            if (button && button.classList.contains('read-more-btn')) {
                button.style.display = 'inline-block';
                button.textContent = 'Leer más';
            }
        } else {
            element.classList.remove('long');
            element.classList.add('short');
            
            // Ocultar el botón si no es necesario
            const button = element.nextElementSibling;
            if (button && button.classList.contains('read-more-btn')) {
                button.style.display = 'none';
            }
        }
    });
}

function toggleDescription(descId, button) {
    const description = document.getElementById(descId);
    
    if (description.classList.contains('long')) {
        // Expandir
        description.style.maxHeight = 'none';
        description.style.webkitLineClamp = 'unset';
        description.classList.remove('long');
        description.classList.add('expanded');
        button.textContent = 'Leer menos';
        
        // Ajustar altura de la tarjeta
        const card = description.closest('.service-card');
        if (card) {
            card.style.minHeight = 'auto';
            card.style.height = 'auto';
        }
    } else {
        // Contraer
        const lineHeight = parseInt(window.getComputedStyle(description).lineHeight);
        description.style.maxHeight = (lineHeight * 3) + 'px';
        description.style.webkitLineClamp = '3';
        description.classList.remove('expanded');
        description.classList.add('long');
        button.textContent = 'Leer más';
        
        // Ajustar altura de la tarjeta
        const card = description.closest('.service-card');
        if (card) {
            card.style.minHeight = '240px';
            card.style.height = 'auto';
        }
    }
}

// Revisar descripciones cuando cambia el tamaño de la ventana
window.addEventListener('resize', function() {
    checkDescriptionsLength();
});

// Función para verificar si hay ofertas activas
async function verificarOfertasActivas() {
    console.log("🎁 VERIFICANDO OFERTAS ACTIVAS");
    
    if (!db) {
        console.log("📱 Firebase no disponible, usando demo");
        return true;
    }
    
    try {
        const ahora = new Date();
        const snapshot = await db.collection('ofertas').where('activa', '==', true).get();
        
        window.ofertasDisponibles = [];
        
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const oferta = doc.data();
                oferta.id = doc.id;
                
                console.log(`🔍 Analizando oferta: ${oferta.nombre || 'Sin nombre'}`);
                
                // Para ofertas con duración por horas
                if (oferta.tipo_duracion === "horas" && oferta.duracion_horas && oferta.creado_en) {
                    const creadoEn = parseFirebaseDate(oferta.creado_en);
                    if (creadoEn) {
                        const finOferta = new Date(creadoEn.getTime() + (oferta.duracion_horas * 60 * 60 * 1000));
                        
                        console.log(`⏰ Oferta por horas:`);
                        console.log(`   Creada: ${creadoEn}`);
                        console.log(`   Duración: ${oferta.duracion_horas} horas`);
                        console.log(`   Vence: ${finOferta}`);
                        console.log(`   Ahora: ${ahora}`);
                        console.log(`   ¿Válida?: ${ahora <= finOferta}`);
                        
                        if (ahora <= finOferta) {
                            window.ofertasDisponibles.push(oferta);
                            console.log(`✅ OFERTA VÁLIDA: ${oferta.nombre}`);
                        }
                    }
                }
                // Para ofertas con fecha/hora específica
                else if (oferta.inicio || oferta.fin) {
                    const inicio = parseFirebaseDate(oferta.inicio);
                    const fin = parseFirebaseDate(oferta.fin);
                    
                    console.log(`📅 Oferta con fechas:`);
                    console.log(`   Inicio: ${inicio}`);
                    console.log(`   Fin: ${fin}`);
                    console.log(`   Ahora: ${ahora}`);
                    
                    let esValida = false;
                    
                    if (inicio && fin) {
                        esValida = (ahora >= inicio && ahora <= fin);
                    } else if (inicio && !fin) {
                        esValida = (ahora >= inicio);
                    } else if (!inicio && fin) {
                        esValida = (ahora <= fin);
                    } else {
                        esValida = true; // Sin fechas límite
                    }
                    
                    if (esValida) {
                        window.ofertasDisponibles.push(oferta);
                        console.log(`✅ OFERTA VÁLIDA: ${oferta.nombre}`);
                    }
                }
                // Ofertas sin fecha límite
                else {
                    console.log(`✅ OFERTA SIN FECHA LÍMITE: ${oferta.nombre}`);
                    window.ofertasDisponibles.push(oferta);
                }
            });
        }
        
        console.log(`🎯 Total ofertas activas: ${window.ofertasDisponibles.length}`);
        
        if (window.ofertasDisponibles.length > 0) {
            ofertaActiva = true;
            
            // DIAGNÓSTICO DETALLADO
            console.log("📋 LISTA DETALLADA DE OFERTAS:");
            window.ofertasDisponibles.forEach((oferta, i) => {
                console.log(`${i+1}. ${oferta.nombre}`);
                console.log(`   Tipo: ${oferta.tipo_duracion || 'sin fecha límite'}`);
                console.log(`   Precio: $${oferta.precio_oferta} (Normal: $${oferta.precio_normal})`);
            });
            
            return true;
        } else {
            ofertaActiva = false;
            console.log("📭 No hay ofertas activas");
            return false;
        }
        
    } catch (error) {
        console.error("❌ Error en verificarOfertasActivas:", error);
        
        // Modo demo
        window.ofertasDisponibles = [{
            nombre: "Corte + Afeitado Especial",
            descripcion: "Corte de cabello + Afeitado clásico",
            precio_oferta: 3900,
            precio_normal: 4700,
            activa: true
        }];
        ofertaActiva = true;
        
        return true;
    }
}

// Función para obtener fecha de hoy en formato YYYY-MM-DD
function getTodayDateString() {
    const hoy = new Date();
    const year = hoy.getFullYear();
    const month = (hoy.getMonth() + 1).toString().padStart(2, '0');
    const day = hoy.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Función para mostrar oferta si corresponde
function mostrarOfertaSiCorresponde() {
    console.log("🎁 mostrarOfertaSiCorresponde llamado");
    console.log("  Oferta activa:", ofertaActiva);
    console.log("  Oferta ya seleccionada:", ofertaSeleccionada);
    console.log("  Ofertas disponibles:", window.ofertasDisponibles ? window.ofertasDisponibles.length : 0);
    
    if (!ofertaActiva || ofertaSeleccionada) {
        console.log("⏭️ No mostrar oferta: inactiva o ya seleccionada");
        return;
    }
    
    if (!window.ofertasDisponibles || window.ofertasDisponibles.length === 0) {
        console.log("⏭️ No hay ofertas disponibles");
        return;
    }
    
    // Solo mostrar si se seleccionó fecha Y hora Y servicio
    if (window.selectedDate && window.selectedTime && window.selectedService) {
        console.log("✅ Todas las condiciones cumplidas, mostrando modal...");
        setTimeout(() => {
            mostrarModalOferta();
        }, 500);
    } else {
        console.log("❌ Faltan condiciones para mostrar oferta");
    }
}

// Función para obtener fecha de hoy en formato YYYY-MM-DD
function getTodayDateString() {
    const hoy = new Date();
    const year = hoy.getFullYear();
    const month = (hoy.getMonth() + 1).toString().padStart(2, '0');
    const day = hoy.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Función para cerrar oferta
function cerrarOferta() {
    console.log("❌ Oferta rechazada por el usuario");
    
    // 🔴 NUEVO: Registrar que el usuario rechazó la oferta para esta fecha y hora
    if (window.selectedDate && window.selectedTime) {
        const claveOferta = `${window.selectedDate}_${window.selectedTime}`;
        ofertaRechazadaParaFechaHora[claveOferta] = true;
        console.log(`✅ Oferta registrada como rechazada para: ${claveOferta}`);
    }
    
    ofertaSeleccionada = false;
    cerrarModalOferta();
    showNotification("Puedes seleccionar otro servicio si lo prefieres", "info");
}

// Función para obtener la fecha de hoy en formato YYYY-MM-DD
function getTodayDateString() {
    const hoy = new Date();
    const year = hoy.getFullYear();
    const month = (hoy.getMonth() + 1).toString().padStart(2, '0');
    const day = hoy.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Función para mostrar la oferta cuando se selecciona fecha y hora
function mostrarOfertaSiCorresponde() {
    if (!ofertaActiva || ofertaSeleccionada) {
        return;
    }
    
    // Solo mostrar si se seleccionó fecha Y hora
    if (window.selectedDate && window.selectedTime && window.selectedService) {
        setTimeout(() => {
            mostrarModalOferta();
        }, 500); // Pequeño delay para mejor UX
    }
}

// Función para mostrar el modal de oferta
function mostrarModalOferta() {
    console.log("🔧 [DEBUG] mostrarModalOferta llamado");
    console.log("Ofertas disponibles:", window.ofertasDisponibles);
    
    if (!window.ofertasDisponibles || window.ofertasDisponibles.length === 0) {
        console.log("No hay ofertas disponibles para mostrar");
        return;
    }
    
    // Tomar la primera oferta activa
    const oferta = window.ofertasDisponibles[0];
    
    const ofertaModal = document.getElementById('ofertaModal');
    if (!ofertaModal) {
        console.error("❌ Modal no encontrado!");
        return;
    }
    
    // Actualizar contenido del modal con datos de Firebase
    const tituloElem = ofertaModal.querySelector('.oferta-titulo');
    const subtituloElem = ofertaModal.querySelector('.oferta-subtitulo');
    const descripcionElem = ofertaModal.querySelector('.oferta-descripcion');
    const precioOfertaElem = ofertaModal.querySelector('.precio-oferta-valor');
    const precioNormalElem = ofertaModal.querySelector('.precio-normal-valor');
    const ahorroElem = ofertaModal.querySelector('.ahorro-texto');
    
    if (tituloElem) tituloElem.textContent = oferta.título || oferta.nombre || "OFERTA ESPECIAL";
    if (subtituloElem) subtituloElem.textContent = oferta.subtítulo || "¡Oferta limitada!";
    if (descripcionElem) descripcionElem.textContent = oferta.descripcion || "Servicio especial";
    
    if (precioOfertaElem) {
        precioOfertaElem.textContent = `$${oferta.precio_oferta?.toLocaleString('es-AR') || "3.900"}`;
    }
    
    if (precioNormalElem) {
        precioNormalElem.textContent = `$${oferta.precio_normal?.toLocaleString('es-AR') || "4.700"}`;
    }
    
    if (ahorroElem && oferta.precio_normal && oferta.precio_oferta) {
        const ahorro = oferta.precio_normal - oferta.precio_oferta;
        const porcentaje = Math.round((ahorro / oferta.precio_normal) * 100);
        ahorroElem.textContent = `¡AHORRA $${ahorro.toLocaleString('es-AR')} (${porcentaje}%)!`;
    }
    
    // Mostrar el modal
    ofertaModal.classList.add('active');
    ofertaModal.style.display = 'flex';
    
    // Configurar botones
    const aceptarBtn = document.getElementById('aceptarOfertaBtn');
    const cerrarBtn = document.getElementById('cerrarOfertaBtn');
    
    if (aceptarBtn) {
        aceptarBtn.onclick = function() {
            aceptarOfertaEspecial(oferta);
        };
    }
    
    if (cerrarBtn) {
        cerrarBtn.onclick = cerrarOferta;
    }
}

// Función para aceptar la oferta
function aceptarOfertaEspecifica(oferta) {
    console.log("✅ ACEPTAR OFERTA ESPECÍFICA INICIADA");
    
    // 🔴 CRÍTICO: Verificar que no estemos ya procesando
    if (window.procesandoOferta) {
        console.log("⏸️ Ya se está procesando una oferta, ignorando");
        return;
    }
    
    window.procesandoOferta = true;
    
    try {
        console.log("Oferta a aceptar:", oferta);
        console.log("Datos de la oferta:", {
            nombre: oferta.nombre,
            precio_oferta: oferta.precio_oferta,
            precio_normal: oferta.precio_normal,
            descripcion: oferta.descripcion
        });
        
        ofertaSeleccionada = true;
        
        // Usar datos de la oferta específica
        const nombreServicio = oferta.nombre || "Oferta Especial";
        const precio = parseInt(oferta.precio_oferta) || 3900;
        const precioNormal = parseInt(oferta.precio_normal) || 4700;
        
        // 🔴 CRÍTICO: Verificar que los precios sean números
        if (isNaN(precio)) {
            console.error("❌ Precio de oferta no es un número:", oferta.precio_oferta);
            showNotification("Error: precio de oferta inválido", "error");
            window.procesandoOferta = false;
            return;
        }
        
        // Actualizar el servicio seleccionado
        window.selectedService = nombreServicio;
        window.servicePrices[nombreServicio] = precio;
        
        console.log(`Servicio seleccionado: ${nombreServicio}`);
        console.log(`Precio establecido: $${precio}`);
        
        // Actualizar el selector de servicios
        const serviceSelect = document.getElementById('serviceSelect');
        if (serviceSelect) {
            // 🔴 PRIMERO: Guardar opciones existentes (excepto la oferta si ya existe)
            const opcionesExistentes = Array.from(serviceSelect.options).filter(
                option => option.value !== nombreServicio
            );
            
            // 🔴 LIMPIAR el selector
            serviceSelect.innerHTML = '';
            
            // Agregar opción vacía
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Selecciona un servicio';
            serviceSelect.appendChild(emptyOption);
            
            // Agregar servicios normales
            const serviciosNormales = [
                { value: "Corte de Cabello", text: "Corte de Cabello - $2.500", precio: 2500 },
                { value: "Corte + Barba", text: "Corte + Barba - $3.200", precio: 3200 },
                { value: "Arreglo de Barba", text: "Arreglo de Barba - $1.800", precio: 1800 },
                { value: "Afeitado Clásico", text: "Afeitado Clásico - $2.200", precio: 2200 }
            ];
            
            serviciosNormales.forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio.value;
                option.textContent = servicio.text;
                option.dataset.precio = servicio.precio;
                serviceSelect.appendChild(option);
            });
            
            // 🔴 FINALMENTE: Agregar la oferta
            const ofertaOption = document.createElement('option');
            ofertaOption.value = nombreServicio;
            ofertaOption.textContent = `${nombreServicio} - $${precio.toLocaleString('es-AR')} (OFERTA)`;
            ofertaOption.style.color = "#25D366";
            ofertaOption.style.fontWeight = "bold";
            ofertaOption.dataset.precio = precio;
            ofertaOption.dataset.esOferta = "true";
            serviceSelect.appendChild(ofertaOption);
            
            // 🔴 CRÍTICO: Seleccionar automáticamente la oferta
            serviceSelect.value = nombreServicio;
            
            console.log(`Selector actualizado, valor seleccionado: ${serviceSelect.value}`);
            
            // 🔴 IMPORTANTE: Actualizar el resumen INMEDIATAMENTE
            updateReservationSummary();
            
            // 🔴 NO disparar evento change automáticamente para evitar bucle
        }
        
        // Actualizar resumen
        updateReservationSummary();
        
        // Calcular ahorro para notificación
        let mensajeNotificacion = `🎉 ¡Oferta aplicada! ${nombreServicio} por $${precio.toLocaleString('es-AR')}`;
        
        if (precioNormal && precioNormal > precio) {
            const ahorro = precioNormal - precio;
            const porcentaje = Math.round((ahorro / precioNormal) * 100);
            mensajeNotificacion += ` (Ahorras $${ahorro.toLocaleString('es-AR')} - ${porcentaje}%)`;
        }
        
        if (oferta.tipo_duracion === "horas") {
            mensajeNotificacion += ` (Válida por ${oferta.duracion_horas} horas)`;
        }
        
        showNotification(mensajeNotificacion, "success");
        
        // 🔴 Cerrar el modal DESPUÉS de un breve delay
        setTimeout(() => {
            cerrarModalOferta();
            console.log("✅ Modal de oferta cerrado");
            
            // Scroll al formulario
            scrollToReservationForm();
            
            // 🔴 IMPORTANTE: Liberar el bloqueo
            window.procesandoOferta = false;
        }, 500);
        
    } catch (error) {
        console.error("❌ Error en aceptarOfertaEspecifica:", error);
        showNotification("Error al aplicar la oferta", "error");
        window.procesandoOferta = false;
    }
}

// Función para cerrar el modal de oferta
function cerrarModalOferta() {
    const ofertaModal = document.getElementById('ofertaModal');
    if (ofertaModal) {
        ofertaModal.classList.remove('active');

        setTimeout(() => {
            ofertaModal.style.display = 'none';

              // 🔴 RESTAURAR VISIBILIDAD DEL CALENDARIO
            const calendarContainer = document.querySelector('.calendar-container');
            const hoursContainer = document.querySelector('.hours-container');
            if (calendarContainer) calendarContainer.style.opacity = '1';
            if (hoursContainer) hoursContainer.style.opacity = '1';
        }, 300);
    }
}

// Control del indicador de sincronización
let syncIndicator = document.getElementById('syncIndicator');
if (syncIndicator) {
    // Mostrar/ocultar según conexión Firebase
    if (db) {
        syncIndicator.style.display = 'flex';
        
        // Animación cuando hay actualizaciones
        syncIndicator.addEventListener('click', function() {
            if (db) {
                this.classList.add('syncing');
                loadServiciosFromFirebase();
                loadBookedSlotsFromFirebase();
                verificarOfertasActivas();
                
                setTimeout(() => {
                    this.classList.remove('syncing');
                    showNotification('✅ Datos actualizados manualmente', 'success');
                }, 1500);
            }
        });
    }
}
    </script>
</html>
